<!DOCTYPE html>
<html lang="ja">

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="モナドの新しい力！スーパープリキュアモナド！">
    
      <meta name="author" content="Yuji Yamamoto">
    
    <link rel="alternate" type="application/atom+xml" title="Haskell-jp Blog" href="https://haskell.jp/blog/feed.xml" />
    <link rel="icon" href="https://haskell.jp/img/favicon.png" />

    <!-- OGP Settings -->
    <meta property="og:title" content="モナドの新しい力！スーパープリキュアモナド！ - Haskell-jp" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="/posts/2018/super-precure-monad.html" />
    <meta property="og:image" content="https://haskell.jp/blog/img/logo-square.png" />
    <meta property="og:site_name" content="Haskell-jp Blog" />
    <meta property="og:description" content="---# この記事はこの記事は[Haskell Advent Calendar その2](https://qiita.com/advent-calendar/2018/haskell2)兼[プリキュアAdvent Calendar 2018](https://adventar.org/calendars/2984)5日目の記事です。  毎度同時投稿で失礼します。  今年は私用で忙しかったので、のん" />

    <!-- Twitter Card Settings -->
    <meta name="twitter:card" content="summary" />

    

    <title>モナドの新しい力！スーパープリキュアモナド！ - Haskell-jp</title>

    <!-- Bootstrap Core CSS -->
    <link href="../../css/bootstrap.css" rel="stylesheet">
    <!-- <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet"> -->

    <!-- Pandoc syntax highlighting CSS -->
    <link href="../../css/syntax.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../../css/clean-blog.css" rel="stylesheet">

    <!-- Our original CSS -->
    <link href="../../css/style.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://haskell.jp"><img src="../../img/logo.svg"></a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="../../posts/about_us.html">About</a>
                    </li>
                    <li>
                        <a href="../../">Blog</a>
                    </li>
                    <li>
                        <a href="https://join.slack.com/t/haskell-jp/shared_invite/enQtNDY4Njc1MTA5MDQxLWY1ZDVhZjIzMGE1MDMzZDAyNGZmYTU5M2VlODg5NTNmY2QwNGU1NjJjMjYzN2VjZmRjMDNiNGU0NjI5NDdlMTc">Slack Team</a>
                    </li>
                    <li>
                        <a href="https://www.reddit.com/r/haskell_jp/">Reddit</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>
    
    <!-- Page Header -->
    <header class="intro-header" style="background-image: url('../../img/background.png'); background-color: #F3DFBC;">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  
                  <div lang="ja" class="post-heading">
                  
                    <div class="jumbotron" style="background: #eee;">
                      <h1>モナドの新しい力！スーパープリキュアモナド！</h1>
                      <h2 class="subheading">～タイプセーフプリキュア！を支える技術 その4～</h2><span class="meta">Posted by <a href="http://the.igreque.info/">Yuji Yamamoto(@igrep)</a> on December 27, 2018</span>
                    </div>
                  </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    
<article lang="ja">

    <div class="container">
        <div class="row">
            <div class="col-lg-offset-2 col-lg-8 col-md-offset-1 col-md-10">
                <ul class="social-buttons">
                    <li><div>
                        <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a>
                        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                    </div></li>
                    <li><div>
                        <script type="text/javascript">
                            reddit_target = "haskell_jp";
                            reddit_title  = document.title;
                        </script>
                        <script type="text/javascript" src="//www.redditstatic.com/button/button1.js"></script>
                    </div></li>
                    <li><div>
                        <a data-pocket-label="pocket" data-pocket-count="horizontal" class="pocket-btn" data-lang="en"></a>
                        <script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>
                    </div></li>
                </ul>
            </div>
        </div>
        <div class="row">
            <div id="md-post-content" class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <hr />
<div id="table-of-contents-outer">
<div id="table-of-contents">
<div class="table-of-contents-title">
Contents
</div>
<ul>
<li><a href="#この記事は" title="この記事は">この記事は</a></li>
<li><a href="#課題-プリキュアに変身していない状態で浄化技を使おうとした場合型エラーにしたい" title="課題-プリキュアに変身していない状態で浄化技を使おうとした場合型エラーにしたい">課題<span class="ascii">:</span> プリキュアに変身していない状態で浄化技を使おうとした場合、型エラーにしたい</a></li>
<li><a href="#実現方法-indexed-monadと型レベル連想配列を使う" title="実現方法-indexed-monadと型レベル連想配列を使う">実現方法<span class="ascii">: Indexed Monad</span>と型レベル連想配列を使う</a></li>
<li><a href="#できたもの" title="できたもの">できたもの</a>
<ul>
<li><a href="#super-precure-monadを試す方法" title="super-precure-monadを試す方法">✨<span class="ascii">Super PreCure Monad</span>✨を試す方法</a></li>
</ul></li>
</ul>
</div>
</div>
<h1 id="この記事は"><span class="link-to-here-outer"><a href="#この記事は" title="この記事は"><span class="link-to-here">Link to<br />
here</span></a></span>この記事は</h1>
<p>この記事は<a href="https://qiita.com/advent-calendar/2018/haskell2"><span class="ascii">Haskell Advent Calendar</span> その<span class="ascii">2</span></a>兼<a href="https://adventar.org/calendars/2984">プリキュア<span class="ascii">Advent Calendar 2018</span></a><span class="ascii">5</span>日目の記事です。<br />
毎度同時投稿で失礼します。<br />
今年は私用で忙しかったので、のんびり書いてできあがったら空いてる日に投稿する、という楽なスタイルで書かせていただきました。なのでタイムスリップして<span class="ascii">5</span>日目の記事と言うことにします<small>（それにしてもずいぶん時間かかってしまってすみません、もうクリスマスも過ぎたし…😥）</small>。</p>
<p>今回も例年の私の<span class="ascii">Advent Calendar</span>どおり、<a href="https://github.com/igrep/typesafe-precure">タイプセーフプリキュア！</a>に、最近追加しようとした機能と、その際使用したもろもろの要素技術についての記事です。<br />
タイプセーフプリキュア！そのものについては<a href="https://haskell.jp/blog/posts/2018/substring-parser.html">今年<span class="ascii">9</span>月の記事</a>や、そこで言及しているもっと古い記事をご覧ください。</p>
<h1 id="課題-プリキュアに変身していない状態で浄化技を使おうとした場合型エラーにしたい"><span class="link-to-here-outer"><a href="#課題-プリキュアに変身していない状態で浄化技を使おうとした場合型エラーにしたい" title="課題-プリキュアに変身していない状態で浄化技を使おうとした場合型エラーにしたい"><span class="link-to-here">Link to<br />
here</span></a></span>課題<span class="ascii">:</span> プリキュアに変身していない状態で浄化技を使おうとした場合、型エラーにしたい</h1>
<p>従来より、タイプセーフプリキュア！には、<code>PreCureMonad</code>と呼ばれる、プリキュアの台詞を<code>do</code>記法で組み立てる機能があります。<br />
例えば<span class="ascii">GHCi</span>上で下記のように書くだけで、<a href="https://www.youtube.com/watch?v=oQLIyIZ2vk0">「<span class="ascii">Go!</span> プリンセスプリキュア」のあの名シーン</a>を再現できます<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="op">&gt;</span> <span class="op">:</span>m <span class="dt">ACME.PreCure</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="op">&gt;</span> <span class="op">:</span>{</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="op">&gt;</span> <span class="kw">let</span> scene <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="op">&gt;</span>       say <span class="st">&quot;この罪を抱いたまま、もう一度、グランプリンセスを目指す！&quot;</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="op">&gt;</span>       scarlet <span class="ot">&lt;-</span> transform <span class="dt">Towa</span> (<span class="dt">PrincessPerfume</span> <span class="dt">DressUpKeyScarlet</span>)</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="op">&gt;</span>       scarletModeElegant <span class="ot">&lt;-</span> transform scarlet (<span class="dt">PrincessPerfume</span> <span class="dt">DressUpKeyPhoenix</span>)</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="op">&gt;</span>       purify scarletModeElegant (<span class="dt">ScarletViolin</span> <span class="dt">DressUpKeyPhoenix</span>)</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="op">&gt;</span> <span class="op">:</span>}</a></code></pre></div>
<p>名シーンを単純な文字列のリストとして使いたい場合はこう👇しましょう<small>（出力は手で見やすく加工しています）</small>。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1">ghci<span class="op">&gt;</span> composeEpisode scene</a>
<a class="sourceLine" id="cb2-2" title="2">[ <span class="st">&quot;この罪を抱いたまま、もう一度、グランプリンセスを目指す！&quot;</span></a>
<a class="sourceLine" id="cb2-3" title="3">, <span class="st">&quot;プリキュア！プリンセスエンゲージ！&quot;</span></a>
<a class="sourceLine" id="cb2-4" title="4">, <span class="st">&quot;深紅の炎のプリンセス！キュアスカーレット！&quot;</span></a>
<a class="sourceLine" id="cb2-5" title="5">, <span class="st">&quot;冷たい檻に閉ざされた夢、返していただきますわ。&quot;</span></a>
<a class="sourceLine" id="cb2-6" title="6">, <span class="st">&quot;お覚悟を決めなさい！&quot;</span></a>
<a class="sourceLine" id="cb2-7" title="7">, <span class="st">&quot;エクスチェンジ！モードエレガント！&quot;</span></a>
<a class="sourceLine" id="cb2-8" title="8">, <span class="st">&quot;スカーレット・バイオリン！フェニックス！&quot;</span></a>
<a class="sourceLine" id="cb2-9" title="9">, <span class="st">&quot;羽ばたけ炎の翼！&quot;</span></a>
<a class="sourceLine" id="cb2-10" title="10">, <span class="st">&quot;プリキュア！ フェニックス・ブレイズ！&quot;</span></a>
<a class="sourceLine" id="cb2-11" title="11">, <span class="st">&quot;ごきげんよう。&quot;</span></a>
<a class="sourceLine" id="cb2-12" title="12">]</a></code></pre></div>
<p>さらに<code>printEpisode</code>という関数で実行すれば、<span class="ascii">1</span>行ごとに間隔を置いてあの台詞を再生できます。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1">ghci<span class="op">&gt;</span> printEpisode scene</a>
<a class="sourceLine" id="cb3-2" title="2">この罪を抱いたまま、もう一度、グランプリンセスを目指す！</a>
<a class="sourceLine" id="cb3-3" title="3">プリキュア！プリンセスエンゲージ！</a>
<a class="sourceLine" id="cb3-4" title="4">深紅の炎のプリンセス！キュアスカーレット！</a>
<a class="sourceLine" id="cb3-5" title="5">冷たい檻に閉ざされた夢、返していただきますわ。</a>
<a class="sourceLine" id="cb3-6" title="6">お覚悟を決めなさい！</a>
<a class="sourceLine" id="cb3-7" title="7">エクスチェンジ！モードエレガント！</a>
<a class="sourceLine" id="cb3-8" title="8">スカーレット・バイオリン！フェニックス！</a>
<a class="sourceLine" id="cb3-9" title="9">羽ばたけ炎の翼！</a>
<a class="sourceLine" id="cb3-10" title="10">プリキュア！ フェニックス・ブレイズ！</a>
<a class="sourceLine" id="cb3-11" title="11">ごきげんよう。</a></code></pre></div>
<p>そんな<code>PreCureMonad</code>ですが、先ほどのコードをよく読めばわかるとおり、ちょっと不格好ですよね。<br />
具体的には下記の<span class="ascii">2</span>行です。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1">scarlet <span class="ot">&lt;-</span> transform <span class="dt">Towa</span> (<span class="dt">PrincessPerfume</span> <span class="dt">DressUpKey_Scarlet</span>)</a>
<a class="sourceLine" id="cb4-2" title="2">scarletModeElegant <span class="ot">&lt;-</span> transform scarlet (<span class="dt">PrincessPerfume</span> <span class="dt">DressUpKeyPhoenix</span>)</a></code></pre></div>
<p><span class="ascii">1</span>行目の<code>transform</code>関数が、変身する女の子である<code>Towa</code>（赤城トワ）と変身アイテムを受け取って<code>CureScarlet</code>を返し、さらにその<code>CureScarlet</code>を<span class="ascii">2</span>行目の<code>transform</code>関数に渡すことでキュアスカーレットのモード・エレガント（<code>CureScarlet_ModeElegant</code>）を取得しています。<br />
「<code>transform</code>関数が、変身する女の子である<code>Towa</code>（赤城トワ）と変身アイテムを受け取って<code>CureScarlet</code>を」返すという箇所について、<code>Towa</code>に<strong>加えて</strong><code>CureScarlet</code>を<strong>新しく作っている</strong>ように聞こえます。<br />
本来同一人物であるはずの<code>Towa</code>と<code>CureScarlet</code>を、あたかも別々のものとして扱っているように捉えられかねません。<br />
そう、本来プリキュアの「変身」は女の子自身の状態を書き換えるものとして表現した方が自然なのです。</p>
<p><span class="ascii">Haskell</span>でそうした「状態」を表現する場合、名前のとおり<code>State</code> <span class="ascii">Monad</span>を使うのが割と一般的な方法です<small>（プログラム全体で状態を管理する場合、<code>IORef</code>や<code>TVar</code>などを使う方が例外に強く安全ではありますが、それはさておき）</small>。<br />
しかし、従来の<code>State</code> <span class="ascii">Monad</span>でプリキュアの変身や浄化技を表現する場合、<strong>女の子が変身していない状態で浄化技<span class="ascii">(</span><code>purify</code><span class="ascii">)</span>を使おうとした場合をどのように扱うか</strong>、という問題があります。<br />
先ほどの例で言うところの</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1">purify scarletModeElegant (<span class="dt">ScarletViolin</span> <span class="dt">DressUpKeyPhoenix</span>)</a></code></pre></div>
<p>という行でまさにその「浄化技」を実行しているのですが、プリキュアの設定上、特定の浄化技を使うには、特定のプリキュアのフォームに、専用のアイテムを渡さなければなりません。<br />
タイプセーフプリキュア！ではこの点に強くこだわり、浄化技が使用できる組み合わせごとに型クラスのインスタンスを定義することで、間違った組み合わせを<code>purify</code>関数に渡すと、型エラーになります<small>（詳しくは<a href="https://qiita.com/igrep/items/5496fa405fae00b5a737">タイプセーフプリキュア！を最初に技術的に解説した記事</a>をご覧ください）</small>。<br />
当然、まだ変身していない状態の女の子を<code>purify</code>関数に渡しても、エラーになってしまいます。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="op">&gt;</span> scene <span class="ot">=</span> purify <span class="dt">Towa</span> (<span class="dt">ScarletViolin</span> <span class="dt">DressUpKeyPhoenix</span>)</a>
<a class="sourceLine" id="cb6-2" title="2"></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="op">&lt;</span>interactive<span class="op">&gt;:</span><span class="dv">4</span><span class="op">:</span><span class="dv">9</span><span class="op">:</span> <span class="fu">error</span><span class="op">:</span></a>
<a class="sourceLine" id="cb6-4" title="4">    • <span class="dt">No</span> <span class="kw">instance</span> for (<span class="dt">Purification</span></a>
<a class="sourceLine" id="cb6-5" title="5">                         <span class="dt">Towa</span> (<span class="dt">ScarletViolin</span> <span class="dt">DressUpKeyPhoenix</span>))</a>
<a class="sourceLine" id="cb6-6" title="6">        arising from a use <span class="kw">of</span> ‘purify’</a>
<a class="sourceLine" id="cb6-7" title="7">    • <span class="dt">In</span> the expression<span class="op">:</span> purify <span class="dt">Towa</span> (<span class="dt">ScarletViolin</span> <span class="dt">DressUpKeyPhoenix</span>)</a>
<a class="sourceLine" id="cb6-8" title="8">      <span class="dt">In</span> an equation for ‘scene’<span class="op">:</span></a>
<a class="sourceLine" id="cb6-9" title="9">          scene <span class="ot">=</span> purify <span class="dt">Towa</span> (<span class="dt">ScarletViolin</span> <span class="dt">DressUpKeyPhoenix</span>)</a></code></pre></div>
<p>プリキュア実装の大先輩である<a href="https://github.com/sue445/rubicure"><span class="ascii">rubicure</span></a>では、同じようなケースで実行時エラーを出すようにしていますし、<span class="ascii">PreCure Monad</span>においても、<code>ExceptT</code>を使ってエラーにする、という方法が採れるでしょう。<br />
しかしそこは「タイプセーフプリキュア！」。どうにかして、変身していない状態での<code>purify</code>関数の実行を型エラーにして、従来のこの振る舞いと一貫させたいところですよね。<br />
というのが今回の課題です。</p>
<h1 id="実現方法-indexed-monadと型レベル連想配列を使う"><span class="link-to-here-outer"><a href="#実現方法-indexed-monadと型レベル連想配列を使う" title="実現方法-indexed-monadと型レベル連想配列を使う"><span class="link-to-here">Link to<br />
here</span></a></span>実現方法<span class="ascii">: Indexed Monad</span>と型レベル連想配列を使う</h1>
<p>今回の課題のとおり、「変身していない状態での<code>purify</code>関数の実行を型エラー」としつつ、「変身した状態での<code>purify</code>を型エラーとしない」ためには、<code>purify</code>や<code>transform</code>を実行する前後で、<code>State</code> <span class="ascii">Monad</span>内で共有している値の型を変更できるようにする必要があります。<br />
残念ながら、これは従来の<code>State</code> <span class="ascii">Monad</span>では不可能です。<br />
<code>State s</code>に対する<code>&gt;&gt;=</code>の型が<code>(&gt;&gt;=) :: State s a -&gt; (a -&gt; State s b) -&gt; State s b</code>となっていることから察せられるとおり、<code>State</code> <span class="ascii">Monad</span>の中で共有する型は、アクションの実行前後にかかわらず同じ<code>s</code>でないといけないためです。<br />
これはそもそも従来の<span class="ascii">Monad</span>の仕様上やむを得ないことです。<br />
従来の<span class="ascii">Monad</span>はそもそもアクションの実行前後で、アクションの実行結果以外の型を変えることができないようになっています。<br />
<code>&gt;&gt;=</code>の型が<code>(&gt;&gt;=) :: Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b</code>となっていることからしても、アクションの実行前後で<code>m</code>は<code>m</code>のままであることがわかります。</p>
<p>この、「アクションの実行前後で、<code>m</code>の型を変えることができる」ようにしたのが<span class="ascii">Indexed Monad</span>です。<br />
<span class="ascii">Indexed Monad</span>は次のような型宣言にすることで、アクションの実行前後で異なる型の “<span class="ascii">index</span>” を挟めるようになっています。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">class</span> <span class="dt">IxApplicative</span> m <span class="ot">=&gt;</span> <span class="dt">IxMonad</span> m <span class="kw">where</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="ot">  ibind ::</span> (a <span class="ot">-&gt;</span> m j k b) <span class="ot">-&gt;</span> m i j a <span class="ot">-&gt;</span> m i k b</a></code></pre></div>
<p><code>IxApplicative</code>は名前のとおり<code>IxMonad</code>と同様に“<span class="ascii">index</span>”が付いた<code>Applicative</code>となっています。<a href="http://hackage.haskell.org/package/indexed-0.1/docs/Control-Monad-Indexed.html">詳しい定義はドキュメント</a>をご覧ください。</p>
<p>唯一のメソッドである<code>ibind</code>が、普通の<span class="ascii">Monad</span>における<code>&gt;&gt;=</code>の引数をひっくり返して“<span class="ascii">index</span>”を追加したものです。<br />
<code>(&gt;&gt;=) :: Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b</code>の<code>m</code>に、型引数が<span class="ascii">2</span>つ追加されていますね？これが“<span class="ascii">index</span>”です。<br />
ある<code>IxMonad</code> <code>m</code>が<code>m i j a</code>という形で型引数を渡されている時、<code>i</code>がアクションを実行する<strong>前</strong>の型、<code>j</code>がアクションを実行した<strong>後</strong>の型を表します。<br />
<code>a</code>は普通の<code>Monad</code>と同様、アクションの実行結果となっています。</p>
<p>さらに<span class="ascii">Indexed</span>な<code>State</code> <span class="ascii">Monad (</span><code>IxState</code><span class="ascii">)</span>で使えるアクションの型宣言を見れば、<code>IxState</code>で共有している状態の型が、アクションの実行前後で変更できることがよりはっきりとわかるでしょう。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="ot">iget ::</span>      <span class="dt">IxState</span> i i i</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">-- ^ igetしてもIxStateが管理している状態は変わらないため、型もやはり変わらず。</span></a>
<a class="sourceLine" id="cb8-3" title="3"></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="ot">iput ::</span> j <span class="ot">-&gt;</span> <span class="dt">IxState</span> i j ()</a>
<a class="sourceLine" id="cb8-5" title="5"><span class="co">-- ^ iputするとIxStateが管理している状態は、引数で渡した値の型に変わる。</span></a></code></pre></div>
<p>こちらもおなじみ<a href="http://hackage.haskell.org/package/mtl"><span class="ascii">mtl</span>パッケージ</a>にある<code>State</code> <span class="ascii">Monad</span>に、単純に “<span class="ascii">index</span>” を加えただけのものとなっています。</p>
<p><a href="http://fumieval.hatenablog.com/entry/2013/05/04/144840"><span class="ascii">Indexed Monad</span>の世界 <span class="ascii">-</span> モナドとわたしとコモナド</a>で紹介された際の<span class="ascii">Indexed Monad</span>は、<code>ido</code>という<span class="ascii">Quasi Quote</span>を使って<code>do</code>記法を無理矢理シミュレートしていましたが、現在は<span class="ascii">GHC</span>の<code>RebindableSyntax</code>という拡張を使うことで、普通の<code>do</code>記法をそのまま利用することができるようになりました<small>（例は後で紹介します）</small>。<br />
さらに、現在は<code>RebindableSyntax</code>を使った場合の諸々の問題を回避するべく、<a href="https://github.com/jbracker/supermonad"><span class="ascii">Indexed Monad</span>を一般化した<span class="ascii">Super Monad</span>と、それを簡単に使えるようにした<span class="ascii">GHC</span>の型チェッカープラグイン</a>が作られたり、<a href="https://github.com/isovector/do-notation"><span class="ascii">do-notation</span>という、<span class="ascii">Indexed Monad</span>と普通の<span class="ascii">Monad</span>を型クラスで抽象化したパッケージ</a>が作られたりしています。<br />
今回は純粋に<span class="ascii">Indexed Monad</span>を使うだけで十分だったので、<span class="ascii">Super Monad</span>や<span class="ascii">do-notation</span>は使用しませんでしたが、今後<span class="ascii">Indexed Monad</span>をもっと実践的に使用する機会があれば、使用してみたいと思います。</p>
<p><span class="ascii">Indexed Monad</span>を使用することで、<code>State</code> <span class="ascii">Monad</span>で共有している状態の型を、アクションの実行前後で変更できるようになりました。<br />
続いて、各女の子の状態を、<code>State</code> <span class="ascii">Monad</span>で共有している状態の型として、どのように管理するかを検討しましょう。<br />
というのも、タイプセーフプリキュア！には最新の<span class="ascii">master</span>の時点で<span class="ascii">59</span>人の女の子が収録されている<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>のですが、それらすべてを変身前と変身後に分けて管理するだけでも、<span class="ascii">2 ^ 59</span>通りの状態を型として表現できなければなりません。<br />
これを直感的に表現できるようにするために、ちょっと型レベルプログラミングの力を借りましょう。そこで登場するのが「型レベル連想配列」です。<br />
「型レベル連想配列」という言い方はあまりしないのでピンとこないかも知れませんが、要するに型<small>（タイプセーフプリキュア！の場合、プリキュアに変身する女の子一人一人に個別の型を割り当てているので、その個別の型）</small>と、それに対応する値のペアを含んだ型レベルリストです。<br />
大雑把に言うと、下記👇のような内容となります<small>（実際にはもう少し違う型で構成されています）</small>。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1">[ (<span class="dt">Hana</span>,   <span class="dt">HasTransformed</span> <span class="dt">'True</span>)</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">-- ^ プリキュアに変身する女の子を表す型（この場合「HUGっと！プリキュア」の野乃はな）</span></a>
<a class="sourceLine" id="cb9-3" title="3"></a>
<a class="sourceLine" id="cb9-4" title="4">, (<span class="dt">Saaya</span>,  <span class="dt">HasTransformed</span> <span class="dt">'False</span>)</a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">--         ^ 対応する女の子が変身しているかどうかを表すsingleton type。</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="co">--           DataKindsで型に持ち上げられたBoolを、普通の値として扱えるよう変換するためのラッパー。</span></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="co">--           申し訳なくもsingleton typeについては割愛します。</span></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="co">--           Haskell-jpのSlack Workspaceあたりでリクエストがあったら書こうかな。</span></a>
<a class="sourceLine" id="cb9-9" title="9"></a>
<a class="sourceLine" id="cb9-10" title="10">, (<span class="dt">Homare</span>, <span class="dt">HasTransformed</span> <span class="dt">'False</span>)</a>
<a class="sourceLine" id="cb9-11" title="11">, <span class="op">...</span></a>
<a class="sourceLine" id="cb9-12" title="12">]</a></code></pre></div>
<p>別の視点で見ると、これはいわゆる<span class="ascii">Extensible Record</span>とも似ています。<br />
<a href="http://hackage.haskell.org/package/extensible"><span class="ascii">extensible</span>パッケージ</a>や<a href="https://github.com/chrisdone/labels"><span class="ascii">labels</span>パッケージ</a>、<a href="https://www.athiemann.net/2017/07/02/superrecord.html"><span class="ascii">superrecord</span>パッケージ</a>がそうしているように、<span class="ascii">Extensible Record</span>は、フィールドのラベルを表す<small>（型レベルの、静的な）</small>文字列をキーとして、それに対応する値を含んだ連想配列として見なすことができるためです。<br />
事実私は今回、<span class="ascii">extensible</span>を使ってこの機能を実装しました。他の<span class="ascii">Extensible Record</span>の実装でも良かったのですが、これ以外のものを全く使ったことがないので😅。</p>
<h1 id="できたもの"><span class="link-to-here-outer"><a href="#できたもの" title="できたもの"><span class="link-to-here">Link to<br />
here</span></a></span>できたもの</h1>
<p><span class="ascii">Indexed Monad</span>と<span class="ascii">Extensible Record</span>を組み合わせることで、<span class="ascii">PreCureMonad</span>の各種アクションを、次のように置き換えられることがわかりました。</p>
<ul>
<li><code>transform &lt;girl&gt; &lt;item&gt;</code><span class="ascii">:</span>
<ul>
<li><code>IxState</code>（実際にはその<span class="ascii">Monad Transformer</span>版である<code>IxStateT</code>）で共有している型レベル連想配列のキー<code>&lt;girl&gt;</code>に対応する値を「変身した状態」に更新する。</li>
<li><code>&lt;girl&gt;</code>がすでに変身している状態の場合は、型レベル連想配列のキー<code>&lt;girl&gt;</code>に対応する値が「変身した状態」になっているので型エラーとする。</li>
<li><code>IxStateT</code>をかぶせた<code>Writer</code> <span class="ascii">Monad</span>で共有しているリストに、<code>&lt;girl&gt;</code>と<code>&lt;item&gt;</code>に対応した、変身時の台詞（文字列）を追記する。</li>
</ul></li>
<li><code>purify &lt;precure&gt; &lt;item&gt;</code><span class="ascii">:</span>
<ul>
<li><code>IxStateT</code>で共有している型レベル連想配列のキーを取得するため、<code>&lt;precure&gt;</code>にあらかじめ定義しておいた<span class="ascii">Type Family</span> <code>AsGirl</code>を適用する。
<ul>
<li><code>AsGirl</code>で取得した型を、これ以降<code>&lt;girl&gt;</code>と呼びます。</li>
</ul></li>
<li><code>&lt;girl&gt;</code>が「変身した状態」になっていない場合は、型レベル連想配列のキー<code>&lt;girl&gt;</code>に対応する値が「変身していない状態」になっているので型エラーとする。</li>
<li><code>IxStateT</code>をかぶせた<code>Writer</code> <span class="ascii">Monad</span>で共有しているリストに、<code>&lt;precure&gt;</code>と<code>&lt;item&gt;</code>に対応した、浄化技を使用したときの台詞（文字列）を追記する。</li>
</ul></li>
</ul>
<p>このように生まれ変わった<span class="ascii">PreCure Monad</span>を<strong>✨<span class="ascii">Super PreCure Monad</span>✨</strong>と呼ぶこととします💪</p>
<p>下記が<span class="ascii">Super PreCure Monad</span>のサンプルコードです。<br />
野乃はながキュアエールに変身して、「ハート・フォー・ユー」という浄化技を放つまでを表しています。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1"><span class="ot">cureYell ::</span> <span class="dt">PreCureM</span> (<span class="dt">StatusTable</span> '[]) (<span class="dt">StatusTable</span> '[<span class="dt">Hana</span> <span class="op">&gt;:</span> <span class="dt">HasTransformed</span> <span class="dt">'True</span>]) ()</a>
<a class="sourceLine" id="cb10-2" title="2">cureYell <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-3" title="3">  enter <span class="dt">Hana</span></a>
<a class="sourceLine" id="cb10-4" title="4">  transform <span class="dt">Hana</span> (<span class="dt">PreHeart</span> <span class="dt">MiraiCrystalPink</span>)</a>
<a class="sourceLine" id="cb10-5" title="5">  purify <span class="dt">CureYell</span> (<span class="dt">PreHeart</span> <span class="dt">MiraiCrystalPink</span>)</a></code></pre></div>
<p><code>enter</code>は、旧<span class="ascii">PreCureMonad</span>にはない、<span class="ascii">Super PreCure Monad</span>に新しく追加されたアクションです。<br />
引数で指定された女の子や、女の子が変身したプリキュアを「登場」させます。<br />
具体的には、以下のように振る舞います。</p>
<ul>
<li>引数で指定された値が女の子<code>&lt;girl&gt;</code>であれば、<code>IxStateT</code>で共有している型レベル連想配列のキー<code>&lt;girl&gt;</code>に対応する値を「変身していない状態」で追加する。</li>
<li>引数で指定された値がすでに変身したプリキュア<code>&lt;precure&gt;</code>であれば、<code>&lt;precure&gt;</code>に<span class="ascii">Type Family</span> <code>AsGirl</code>を適用し、女の子を表す値<code>&lt;girl&gt;</code>を取得する。
<ul>
<li><code>IxStateT</code>で共有している型レベル連想配列のキー<code>&lt;girl&gt;</code>に対応する値を「変身した状態」で追加する。</li>
</ul></li>
</ul>
<p>したがって、<code>transform</code>するにしても<code>purify</code>するにしても、事前に変身前の女の子かその変身後のプリキュアが<code>enter</code>していないといけません。<br />
これは単純にその方が実装が簡単だから、という理由もありますし、一旦「登場」させたほうがなんとなくかっこいいかな、と感じたからです。</p>
<h2 id="super-precure-monadを試す方法"><span class="link-to-here-outer"><a href="#super-precure-monadを試す方法" title="super-precure-monadを試す方法"><span class="link-to-here">Link to<br />
here</span></a></span>✨<span class="ascii">Super PreCure Monad</span>✨を試す方法</h2>
<p>ここまで述べたような基本的な仕様は実装できたものの、まだ解決すべき技術的な問題が見つかったので、残念ながらリリースはされていません<small>（その詳細は気が向いたら書きます）</small>。<br />
なので、試す場合は下記のように実行してください。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="op">$</span> chcp <span class="dv">65001</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="co">-- ^ Windowsの方は恐らく必要</span></a>
<a class="sourceLine" id="cb11-3" title="3"></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="op">$</span> git clone <span class="op">-</span>b super<span class="op">-</span>precure<span class="op">-</span>monad https<span class="op">://</span>github<span class="op">.</span>com<span class="op">/</span>igrep<span class="op">/</span>typesafe<span class="op">-</span>precure<span class="op">.</span>git</a>
<a class="sourceLine" id="cb11-5" title="5"><span class="op">$</span> cd typesafe<span class="op">-</span>precure</a>
<a class="sourceLine" id="cb11-6" title="6"><span class="op">$</span> stack build</a>
<a class="sourceLine" id="cb11-7" title="7"><span class="op">$</span> stack exec ghci</a>
<a class="sourceLine" id="cb11-8" title="8"><span class="op">&gt;</span> <span class="op">:</span>set <span class="op">-</span><span class="dt">XRebindableSyntax</span> <span class="op">-</span><span class="dt">XFlexibleContexts</span> <span class="op">-</span><span class="dt">XTypeFamilies</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="op">&gt;</span> <span class="kw">import</span> <span class="dt">Prelude</span> <span class="kw">hiding</span> ((&gt;&gt;), (&gt;&gt;=))</a>
<a class="sourceLine" id="cb11-10" title="10"><span class="op">&gt;</span> <span class="op">:</span>m <span class="op">+</span> <span class="dt">ACME.PreCure</span> <span class="dt">ACME.PreCure.Monad.Super</span></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="op">&gt;</span> <span class="op">:</span>{</a>
<a class="sourceLine" id="cb11-12" title="12"><span class="op">&gt;</span> scene <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="op">&gt;</span>       enter <span class="dt">Makoto</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="op">&gt;</span>       transform <span class="dt">Makoto</span> (<span class="dt">LovelyCommuneDavi</span> <span class="dt">CureLoveads</span>)</a>
<a class="sourceLine" id="cb11-15" title="15"><span class="op">&gt;</span>       purify <span class="dt">CureSword</span> (<span class="dt">LovelyCommuneDavi</span> <span class="dt">CureLoveads</span>)</a>
<a class="sourceLine" id="cb11-16" title="16"><span class="op">&gt;</span> <span class="op">:</span>}</a>
<a class="sourceLine" id="cb11-17" title="17"><span class="op">&gt;</span> printEpisode scene</a>
<a class="sourceLine" id="cb11-18" title="18">(ダビィー！)</a>
<a class="sourceLine" id="cb11-19" title="19">プリキュア！ラブリンク！</a>
<a class="sourceLine" id="cb11-20" title="20">(<span class="dt">L</span><span class="op">!</span> <span class="dt">O</span><span class="op">!</span> <span class="dt">V</span><span class="op">!</span> <span class="dt">E</span><span class="op">!</span>)</a>
<a class="sourceLine" id="cb11-21" title="21">勇気の刃！ キュアソード！</a>
<a class="sourceLine" id="cb11-22" title="22">このキュアソードが 愛の剣で、あなたの野望を断ち切ってみせる！</a>
<a class="sourceLine" id="cb11-23" title="23">閃け！ホーリー・ソード！</a></code></pre></div>
<p>「変身していない状態での<code>purify</code>関数の実行を型エラーとする」といった仕様を試す場合は、<a href="https://github.com/igrep/typesafe-precure/blob/super-precure-monad/gen/AllPreCureM.hs">こちらに置いた、全プリキュアの変身と浄化技を列挙したテスト用ファイル</a>を<span class="ascii">ghci</span>で読んでみるといいでしょう。<br />
先ほど👆の手順で<code>git clone</code>したディレクトリーにおいて、あらかじめ<code>stack build</code>を実行しておくのをお忘れなく。</p>
<pre><code>$ stack build
$ stack exec ghci gen/AllPreCureM.hs</code></pre>
<p>適当に<code>gen/AllPreCureM.hs</code>を書き換えて<code>:r</code>してみれば、概ねいい感じに動いていることがわかるはずです。</p>
<p>例えば冒頭付近にある、</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1">act_CureDiamond_LovelyCommuneRaquel_CureLoveads <span class="ot">=</span> printEpisode <span class="op">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb13-2" title="2">  enter <span class="dt">Rikka</span></a>
<a class="sourceLine" id="cb13-3" title="3">  transform <span class="dt">Rikka</span> (<span class="dt">LovelyCommuneRaquel</span> <span class="dt">CureLoveads</span>)</a>
<a class="sourceLine" id="cb13-4" title="4">  purify <span class="dt">CureDiamond</span> (<span class="dt">LovelyCommuneRaquel</span> <span class="dt">CureLoveads</span>)</a></code></pre></div>
<p>という<span class="ascii">Super PreCure Monad</span>によるアクションから、<code>transform Rikka (LovelyCommuneRaquel CureLoveads)</code>という行を削除した上で<code>:r</code>してみると、次のようなエラーになります。</p>
<pre><code>&gt; :r
[1 of 1] Compiling AllPreCureM      ( gen\AllPreCureM.hs, interpreted )

gen\AllPreCureM.hs:22:3: error:
    • Couldn't match type ‘'False’ with ‘'True’
        arising from a use of ‘purify’
    • In a stmt of a 'do' block:
        purify CureDiamond (LovelyCommuneRaquel CureLoveads)
      In the second argument of ‘($)’, namely
        ‘do enter Rikka
            purify CureDiamond (LovelyCommuneRaquel CureLoveads)’
      In the expression:
        printEpisode
          $ do enter Rikka
               purify CureDiamond (LovelyCommuneRaquel CureLoveads)
   |
22 |   purify CureDiamond (LovelyCommuneRaquel CureLoveads)
   |   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Failed, no modules loaded.</code></pre>
<p>ちゃんと、変身していない状態で<code>purify</code>することを型エラーにできていますね！</p>
<p>ここまでできていながら残念ですが、リリースは、来年のプリキュアハッカソンか<span class="ascii">Advent Calendar</span>あたりに乞うご期待と言うことで！💦<br />
それでは<span class="ascii">2019</span>年も<span class="ascii">Haskell</span>で<span class="ascii">Super PreCure Hacking</span>を❣️❣️❣️</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>リンク先の動画をご覧になればわかるとおり、実際のそのシーンより大幅に省略されているところは突っ込まないでいただきたい…🙏。<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>「この間の映画に出ていた人数より多くない？」と思った方へ<span class="ascii">:</span> 「プリキュアオールスターズ」に出てくる女の子たちに加え、坂上あゆみ、ペコリン、若宮アンリ、はぐたんの<span class="ascii">4</span>人が、タイプセーフプリキュア！の分類上<code>Girl</code>として収録されています。ちなみにキュアモフルンも収録されていますが、モフルンはあくまでも変身アイテム<span class="ascii">(</span><code>SpecialItem</code><span class="ascii">)</span>という扱いです。<a href="#fnref2" class="footnote-back">↩</a></p></li>
</ol>
</section>
            </div>
        </div>
        <div id="post-navigation" class="row" style="margin-top: 20px;">
            <div class="col-lg-offset-2 col-lg-3 col-md-offset-1 col-md-4 col-xs-4">
                
                <i class="glyphicon glyphicon-chevron-left" aria-hidden="true" style="margin-right: 5px;"></i>
                <a href="../../posts/2019/tidalcycles-stack.html" lang="ja">TidalCyclesをstackで確実にインストールする</a>
                
            </div>
            <div class="col-lg-2 col-md-2 col-xs-4 text-center">
                <a href="../../" lang="ja">トップに戻る</a>
            </div>
            <div class="col-lg-3 col-md-4 col-xs-4">
                
                <a href="../../posts/2018/haskell-day-2018.html" style="margin-left: auto;" lang="ja">Haskell Day 2018 開催レポート</a>
                <i class="glyphicon glyphicon-chevron-right" aria-hidden="true" style="margin-left: 5px;"></i>
                
            </div>
        </div>
    </div>
</article>



    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://github.com/haskell-jp/blog">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <div class="text-muted notice text-center"> <br /><span class="author">&copy; Yuji Yamamoto 2018</span> <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.ja"><img alt="クリエイティブ・コモンズ・ライセンス" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a></div>
                    <div class="text-muted notice text-center">この作品は<a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.ja">クリエイティブ・コモンズ 表示 4.0 国際 ライセンス</a>の下に提供されています。</div>
                    <p class="text-muted notice">
                      当ウェブサイトでは<a href="https://support.google.com/analytics/answer/6004245?hl=ja">Google Analytics</a>でアクセス情報を収集しています。集めた情報は統計的に処理した上で、当ウェブサイトの改善のための参考情報としてのみ使用します。
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="../../js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../../js/bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="../../js/clean-blog.js"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-94110610-1', 'auto');
      ga('send', 'pageview');
    </script>
</body>

</html>
