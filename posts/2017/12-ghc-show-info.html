<!DOCTYPE html>
<html lang="ja">

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="GHCにおける多彩な情報の出力方法">
    
      <meta name="author" content="takenbu.hs">
    
    <link rel="alternate" type="application/atom+xml" title="Haskell-jp Blog" href="https://haskell.jp/blog/feed.xml" />
    <link rel="icon" href="https://haskell.jp/img/favicon.png" />

    <!-- OGP Settings -->
    <meta property="og:title" content="GHCにおける多彩な情報の出力方法 - Haskell-jp" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="/posts/2017/12-ghc-show-info.html" />
    <meta property="og:image" content="https://haskell.jp/blog/img/logo-square.png" />
    <meta property="og:site_name" content="Haskell-jp Blog" />
    <meta property="og:description" content="---## はじめにHaskell用コンパイラであるGHCは、驚くほど多彩な情報出力機能を標準で搭載しています。  出力できる情報は非常に沢山ありますが、ここでは、以下のいくつかの方法について簡単にまとめて紹介します。1. [ghciでの対話操作による情報の出力方法](#ch1)2. [コンパイル時における情報の出力方法](#ch2)3. [実行オブジェクトの実行時における情報の出力方法](#ch" />

    <!-- Twitter Card Settings -->
    <meta name="twitter:card" content="summary" />

    

    <title>GHCにおける多彩な情報の出力方法 - Haskell-jp</title>

    <!-- Bootstrap Core CSS -->
    <link href="../../css/bootstrap.css" rel="stylesheet">
    <!-- <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet"> -->

    <!-- Pandoc syntax highlighting CSS -->
    <link href="../../css/syntax.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../../css/clean-blog.css" rel="stylesheet">

    <!-- Our original CSS -->
    <link href="../../css/style.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://haskell.jp"><img src="../../img/logo.svg"></a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="../../posts/about_us.html">About</a>
                    </li>
                    <li>
                        <a href="../../">Blog</a>
                    </li>
                    <li>
                        <a href="https://haskell.jp/signin-slack.html">Slack Team</a>
                    </li>
                    <li>
                        <a href="https://www.reddit.com/r/haskell_jp/">Reddit</a>
                    </li>
                    <li>
                        <a href="https://github.com/haskell-jp/community/blob/master/GRC.md">GRC</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <div class="ribbon">
            <a href="https://haskell.jp/haskell-day-2021/">
                <div>Haskell Day 2021 開催決定!</div>
            </a>
        </div>
        <!-- /.container -->
    </nav>
    
    <!-- Page Header -->
    <header class="intro-header" style="background-image: url('../../img/background.png'); background-color: #F3DFBC;">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    
                    <div lang="ja" class="post-heading">
                    
                        <div class="jumbotron page-header-jumbotron">
                            <h1>GHCにおける多彩な情報の出力方法</h1>
                            <h2 class="subheading">対話操作による出力、コンパイル時出力、実行時出力</h2><span class="meta">Posted by takenbu.hs on September 10, 2017</span>
                            <div class="text-right" style="margin-top: 2em;">
                                <a class="btn btn-primary" href="https://github.com/haskell-jp/blog#%E8%A8%98%E4%BA%8B%E3%82%92%E6%8A%95%E7%A8%BF%E3%81%97%E3%81%9F%E3%81%84%E5%A0%B4%E5%90%88" role="button">
                                    投稿したい方はこちら
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    
<article lang="ja">

    <div class="container">
        <div class="row">
            <div class="col-lg-offset-2 col-lg-8 col-md-offset-1 col-md-10">
                <ul class="social-buttons">
                    <li><div>
                        <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a>
                        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                    </div></li>
                    <li><div>
                        <script type="text/javascript">
                            reddit_target = "haskell_jp";
                            reddit_title  = document.title;
                        </script>
                        <script type="text/javascript" src="//www.redditstatic.com/button/button1.js"></script>
                    </div></li>
                    <li><div>
                        <a data-pocket-label="pocket" data-pocket-count="horizontal" class="pocket-btn" data-lang="en"></a>
                        <script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>
                    </div></li>
                </ul>
            </div>
        </div>
        <div class="row">
            <div id="md-post-content" class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <hr />
<div id="table-of-contents-outer">
<div id="table-of-contents">
<div class="table-of-contents-title">
Contents
</div>
<ul>
<li><a href="#はじめに" title="はじめに">はじめに</a></li>
<li><a href="#ch1" title="ch1"><span class="ascii">1. ghci</span>での対話操作による情報の出力方法</a>
<ul>
<li><a href="#型typeの情報の出力tコマンド" title="型typeの情報の出力tコマンド">型<span class="ascii">(type)</span>の情報の出力（<code>:t</code>コマンド）</a></li>
<li><a href="#型typeの情報の入門者向けの出力t-dコマンド" title="型typeの情報の入門者向けの出力t-dコマンド">型<span class="ascii">(type)</span>の情報の入門者向けの出力（<code>:t +d</code>コマンド）</a></li>
<li><a href="#型typeの情報の詳細出力t-vコマンド" title="型typeの情報の詳細出力t-vコマンド">型<span class="ascii">(type)</span>の情報の詳細出力（<code>:t +v</code>コマンド）</a></li>
<li><a href="#種kindの情報の出力kコマンド" title="種kindの情報の出力kコマンド">種<span class="ascii">(kind)</span>の情報の出力（<code>:k</code>コマンド）</a></li>
<li><a href="#名前の内容についての情報の出力iコマンド" title="名前の内容についての情報の出力iコマンド">名前の内容についての情報の出力（<code>:i</code>コマンド）</a></li>
<li><a href="#その他ghciのいろいろなコマンド" title="その他ghciのいろいろなコマンド">その他、<span class="ascii">ghci</span>のいろいろなコマンド</a></li>
</ul></li>
<li><a href="#ch2" title="ch2"><span class="ascii">2.</span> コンパイル時における情報の出力方法</a>
<ul>
<li><a href="#コンパイル時の各ステージごとの中間コードの出力" title="コンパイル時の各ステージごとの中間コードの出力">コンパイル時の各ステージごとの中間コードの出力</a>
<ul>
<li><a href="#パーサー後" title="パーサー後">パーサー後</a></li>
<li><a href="#リネーム後" title="リネーム後">リネーム後</a></li>
<li><a href="#脱糖desugar後のcore言語コード" title="脱糖desugar後のcore言語コード">脱糖<span class="ascii">(Desugar)</span>後の、<span class="ascii">Core</span>言語コード</a></li>
<li><a href="#stg中間言語での最適化最終コード" title="stg中間言語での最適化最終コード"><span class="ascii">STG</span>中間言語での最適化最終コード</a></li>
<li><a href="#cmm中間言語での最適化最終コード" title="cmm中間言語での最適化最終コード"><span class="ascii">Cmm</span>中間言語での最適化最終コード</a></li>
<li><a href="#最終アセンブリ命令列" title="最終アセンブリ命令列">最終アセンブリ命令列</a></li>
</ul></li>
<li><a href="#型情報の出力" title="型情報の出力">型情報の出力</a></li>
<li><a href="#正格性情報の出力" title="正格性情報の出力">正格性情報の出力</a></li>
<li><a href="#その他コンパイル時のいろいろなオプション" title="その他コンパイル時のいろいろなオプション">その他、コンパイル時のいろいろなオプション</a></li>
</ul></li>
<li><a href="#ch3" title="ch3"><span class="ascii">3.</span> 実行オブジェクトの実行時における情報の出力方法</a>
<ul>
<li><a href="#実行時の統計情報の出力" title="実行時の統計情報の出力">実行時の統計情報の出力</a></li>
<li><a href="#時間プロファイルの出力" title="時間プロファイルの出力">時間プロファイルの出力</a></li>
<li><a href="#空間プロファイルの出力" title="空間プロファイルの出力">空間プロファイルの出力</a></li>
<li><a href="#実行時イベントの出力" title="実行時イベントの出力">実行時イベントの出力</a>
<ul>
<li><a href="#threadscopeによるgui表示" title="threadscopeによるgui表示"><span class="ascii">ThreadScope</span>による<span class="ascii">GUI</span>表示</a></li>
<li><a href="#ghc-eventsによるテキスト表示" title="ghc-eventsによるテキスト表示"><span class="ascii">ghc-events</span>によるテキスト表示</a></li>
</ul></li>
<li><a href="#コードカバレッジの出力" title="コードカバレッジの出力">コードカバレッジの出力</a></li>
<li><a href="#スタックトレースの出力" title="スタックトレースの出力">スタックトレースの出力</a></li>
</ul></li>
<li><a href="#補足" title="補足">補足</a></li>
</ul>
</div>
</div>
<h2 id="はじめに"><span class="link-to-here-outer"><a href="#はじめに" title="はじめに"><span class="link-to-here">Link to<br />
here</span></a></span>はじめに</h2>
<p><span class="ascii">Haskell</span>用コンパイラである<span class="ascii">GHC</span>は、驚くほど多彩な情報出力機能を標準で搭載しています。<br />
出力できる情報は非常に沢山ありますが、ここでは、以下のいくつかの方法について簡単にまとめて紹介します。</p>
<ol type="1">
<li><a href="#ch1"><span class="ascii">ghci</span>での対話操作による情報の出力方法</a></li>
<li><a href="#ch2">コンパイル時における情報の出力方法</a></li>
<li><a href="#ch3">実行オブジェクトの実行時における情報の出力方法</a></li>
</ol>
<p>なお、本記事では、<span class="ascii">stack</span>コマンド経由ではなく、素の<span class="ascii">GHC</span>を使う場合について説明しています。 <span class="ascii">stack</span>コマンドを使用する場合は、<code>ghc</code>コマンドではなく、<code>stack ghc --</code>コマンドの様に読み替えてください。<br />
また、本記事の実行例は、<span class="ascii">GHC8.2.1</span>と<span class="ascii">Linux(ubuntu 16.04 LTS)</span>環境によるものです。</p>
<hr />
<h2 id="ch1"><span class="link-to-here-outer"><a href="#ch1" title="ch1"><span class="link-to-here">Link to<br />
here</span></a></span><span class="ascii">1. ghci</span>での対話操作による情報の出力方法</h2>
<p>ここでは、<span class="ascii">GHC</span>の対話環境（<span class="ascii">REPL</span>）である<span class="ascii">ghci</span>コマンドを用いた、情報の出力方法について紹介します。</p>
<ul>
<li>型<span class="ascii">(type)</span>の情報の出力（<code>:t</code>コマンド）</li>
<li>型<span class="ascii">(type)</span>の情報の入門者向けの出力（<code>:t +d</code>コマンド）</li>
<li>型<span class="ascii">(type)</span>の情報の詳細出力（<code>:t +v</code>コマンド）</li>
<li>種<span class="ascii">(kind)</span>の情報の出力（<code>:k</code>コマンド）</li>
<li>名前の内容についての情報の出力（<code>:i</code>コマンド）</li>
<li>その他いろいろなコマンド</li>
</ul>
<p>以下、各々の例について説明します。</p>
<h3 id="型typeの情報の出力tコマンド"><span class="link-to-here-outer"><a href="#型typeの情報の出力tコマンド" title="型typeの情報の出力tコマンド"><span class="link-to-here">Link to<br />
here</span></a></span>型<span class="ascii">(type)</span>の情報の出力（<code>:t</code>コマンド）</h3>
<p><span class="ascii">GHC</span>の対話環境である<span class="ascii">ghci</span>上で、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:type"><code>:t</code></a>コマンド（または省略しない形の<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:type"><code>:type</code></a>コマンド）を実行することにより、変数や関数などについての型の情報を表示できます。<br />
以下は、<code>:t length</code>コマンドの実行例です。<br />
<code>ghci</code>コマンドを起動してから、<code>:t length</code>コマンドを実行すると、</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="op">$</span> ghci</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="dt">Prelude</span><span class="op">&gt;</span> <span class="op">:</span>t <span class="fu">length</span></a></code></pre></div>
<p>次の様に出力されます。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">length</span><span class="ot"> ::</span> <span class="dt">Foldable</span> t <span class="ot">=&gt;</span> t a <span class="ot">-&gt;</span> <span class="dt">Int</span></a></code></pre></div>
<p>上の例では、「<span class="ascii">length</span>関数は、<code>t a</code>型の値を入力して、<code>Int</code>型の値を返す関数である」ことを示しています。 また、「型変数<code>t</code>は<code>Foldable</code>クラスに属する」ことを示しています。</p>
<h3 id="型typeの情報の入門者向けの出力t-dコマンド"><span class="link-to-here-outer"><a href="#型typeの情報の入門者向けの出力t-dコマンド" title="型typeの情報の入門者向けの出力t-dコマンド"><span class="link-to-here">Link to<br />
here</span></a></span>型<span class="ascii">(type)</span>の情報の入門者向けの出力（<code>:t +d</code>コマンド）</h3>
<p><span class="ascii">GHC8.2</span>で導入された新しい機能です。<br />
<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:type%20+d"><code>:t +d</code></a>コマンド（または省略しない形の<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:type%20+d"><code>:type +d</code></a>コマンド）を実行することにより、デフォルトの型を考慮して、型の情報を分かりやすく出力できます。<br />
<code>:t +d length</code>コマンドを実行すると、</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="dt">Prelude</span><span class="op">&gt;</span> <span class="op">:</span>t <span class="op">+</span>d <span class="fu">length</span></a></code></pre></div>
<p>次の様に出力されます。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="fu">length</span><span class="ot"> ::</span> [a] <span class="ot">-&gt;</span> <span class="dt">Int</span></a></code></pre></div>
<p>上の例では、<code>+d</code>オプションをつけない<code>:type</code>コマンドと比べると、<code>Foldable t =&gt; t a</code>の部分がリスト型として具体化されて出力されています。</p>
<h3 id="型typeの情報の詳細出力t-vコマンド"><span class="link-to-here-outer"><a href="#型typeの情報の詳細出力t-vコマンド" title="型typeの情報の詳細出力t-vコマンド"><span class="link-to-here">Link to<br />
here</span></a></span>型<span class="ascii">(type)</span>の情報の詳細出力（<code>:t +v</code>コマンド）</h3>
<p><span class="ascii">GHC8.2</span>で導入された新しい機能です。<br />
<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:type%20+v"><code>:t +v</code></a>コマンド（または省略しない形の<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:type%20+v"><code>:type +v</code></a>コマンド）を実行することにより、型についての情報をより詳しく出力できます。<br />
<code>:t +v length</code>コマンドを実行すると、</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1"><span class="dt">Prelude</span><span class="op">&gt;</span> <span class="op">:</span>t <span class="op">+</span>v <span class="fu">length</span></a></code></pre></div>
<p>次の様に出力されます。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="fu">length</span><span class="ot"> ::</span> <span class="dt">Foldable</span> t <span class="ot">=&gt;</span> <span class="kw">forall</span> a<span class="op">.</span> t a <span class="ot">-&gt;</span> <span class="dt">Int</span></a></code></pre></div>
<p>上の例では、<code>+v</code>オプションをつけない<code>:type</code>コマンドと比べると、<code>forall a.</code>の部分が詳しく出力されています。</p>
<h3 id="種kindの情報の出力kコマンド"><span class="link-to-here-outer"><a href="#種kindの情報の出力kコマンド" title="種kindの情報の出力kコマンド"><span class="link-to-here">Link to<br />
here</span></a></span>種<span class="ascii">(kind)</span>の情報の出力（<code>:k</code>コマンド）</h3>
<p><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:kind"><code>:k</code></a>コマンド（または省略しない形の<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:kind"><code>:kind</code></a>コマンド）を実行することにより、種（カインド）についての情報を出力できます。<br />
<code>:k Maybe</code>コマンドを実行すると、</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1"><span class="dt">Prelude</span><span class="op">&gt;</span> <span class="op">:</span>k <span class="dt">Maybe</span></a></code></pre></div>
<p>次の様に出力されます。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="dt">Maybe</span><span class="ot"> ::</span> <span class="op">*</span> <span class="ot">-&gt;</span> <span class="op">*</span></a></code></pre></div>
<p>上の例では、<code>Maybe</code>型は、<code>*</code>の種を入力し、<code>*</code>の種を返す型であることを出力します。</p>
<h3 id="名前の内容についての情報の出力iコマンド"><span class="link-to-here-outer"><a href="#名前の内容についての情報の出力iコマンド" title="名前の内容についての情報の出力iコマンド"><span class="link-to-here">Link to<br />
here</span></a></span>名前の内容についての情報の出力（<code>:i</code>コマンド）</h3>
<p><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:info"><code>:i</code></a>コマンド（または省略しない形の<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:info"><code>:info</code></a>コマンド）を実行することにより、その名前の定義情報などを出力できます。<br />
<code>:i length</code>コマンドを実行すると、</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="dt">Prelude</span><span class="op">&gt;</span> <span class="op">:</span>i <span class="fu">length</span></a></code></pre></div>
<p>次の様に出力されます。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">class</span> <span class="dt">Foldable</span> (<span class="ot">t ::</span> <span class="op">*</span> <span class="ot">-&gt;</span> <span class="op">*</span>) <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="op">...</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="ot">  length ::</span> t a <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb10-4" title="4">  <span class="op">...</span></a>
<a class="sourceLine" id="cb10-5" title="5">  	<span class="co">-- Defined in ‘Data.Foldable’</span></a></code></pre></div>
<p>上の例では、<code>length</code>の定義内容（関数であり、<span class="ascii">Foldable</span>クラスに属しており、<span class="ascii">Data.Foldable</span>モジュール内で定義されていること）が出力されています。</p>
<h3 id="その他ghciのいろいろなコマンド"><span class="link-to-here-outer"><a href="#その他ghciのいろいろなコマンド" title="その他ghciのいろいろなコマンド"><span class="link-to-here">Link to<br />
here</span></a></span>その他、<span class="ascii">ghci</span>のいろいろなコマンド</h3>
<p>他にも<span class="ascii">ghci</span>のコマンドにより、様々な情報を対話的に出力させることが出来ます。</p>
<ul>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:show%20imports"><code>:show imports</code></a> <span class="ascii">: import</span>しているモジュールの一覧出力</li>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-cmd-:help"><code>:help</code></a> <span class="ascii">:</span> コマンドのヘルプ</li>
</ul>
<p><span class="ascii">ghci</span>のコマンドの詳細は、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html#ghci-commands">こちら</a>を参照してください。<br />
<span class="ascii">ghci</span>のコマンドや、型や種<span class="ascii">(</span>カインド<span class="ascii">)</span>については、<a href="https://employment.en-japan.com/engineerhub/entry/2017/08/25/110000#Haskell%E3%81%AE%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E5%9E%8B%E3%81%AB%E8%A6%AA%E3%81%97%E3%82%82%E3%81%86GHCi%E3%82%92%E3%82%82%E3%81%A3%E3%81%A8%E4%BD%BF%E3%81%84%E3%81%93%E3%81%AA%E3%81%97%E3%81%A4%E3%81%A4">こちら</a>や<a href="https://haskell.jp/blog/posts/2017/10-about-kind-system-part1.html">こちら</a>も参考になります。</p>
<hr />
<h2 id="ch2"><span class="link-to-here-outer"><a href="#ch2" title="ch2"><span class="link-to-here">Link to<br />
here</span></a></span><span class="ascii">2.</span> コンパイル時における情報の出力方法</h2>
<p>ここでは、<span class="ascii">GHC</span>のコンパイル時における、情報の出力方法について紹介します。</p>
<ul>
<li>コンパイル時の各ステージごとの中間コードの出力</li>
<li>型情報の出力</li>
<li>正格性情報の出力</li>
</ul>
<p>以下、各々の例について説明します。</p>
<h3 id="コンパイル時の各ステージごとの中間コードの出力"><span class="link-to-here-outer"><a href="#コンパイル時の各ステージごとの中間コードの出力" title="コンパイル時の各ステージごとの中間コードの出力"><span class="link-to-here">Link to<br />
here</span></a></span>コンパイル時の各ステージごとの中間コードの出力</h3>
<p><span class="ascii">GHC</span>は、コンパイル時に、中間言語変換などの<a href="https://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/HscMain">複数のパイプラインステージ</a>を経ながら、最終的にアセンブリコードを生成します。<br />
コンパイル時に<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/debugging.html?highlight=#dumping-out-compiler-intermediate-structures">情報出力用のオプション</a>を指定することにより、それらの各ステージごとの中間コードを出力できます。</p>
<p>例えば、以下の単純なソースの場合について例を示します。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="op">$</span> cat Func1.hs</a>
<a class="sourceLine" id="cb11-2" title="2"></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="kw">module</span> <span class="dt">Func1</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-4" title="4"></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="ot">f1 ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb11-6" title="6">f1 x y <span class="ot">=</span> x <span class="op">+</span> y</a></code></pre></div>
<p>以下、<span class="ascii">GHC</span>のコンパイル・パイプラインにおける、パーサーやリネームなどの各ステージ後のコード出力例を示します。</p>
<h4 id="パーサー後"><span class="link-to-here-outer"><a href="#パーサー後" title="パーサー後"><span class="link-to-here">Link to<br />
here</span></a></span>パーサー後</h4>
<p><span class="ascii">GHC</span>のコンパイルにおける、パーサーのステージ直後のコードを出力するには、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/debugging.html?highlight=#ghc-flag--ddump-parsed"><code>-ddump-parsed</code></a>オプションを指定します。</p>
<pre><code>$ ghc  -ddump-parsed Func1.hs </code></pre>
<p>パーサー後のコードが、以下の様に出力されます。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1">[<span class="dv">1</span> <span class="kw">of</span> <span class="dv">1</span>] <span class="dt">Compiling</span> <span class="dt">Func1</span>            ( Func1.hs, Func1.o ) [flags changed]</a>
<a class="sourceLine" id="cb13-2" title="2"></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="op">====================</span> <span class="dt">Parser</span> <span class="op">====================</span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="kw">module</span> <span class="dt">Func1</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="ot">f1 ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb13-6" title="6">f1 x y <span class="ot">=</span> x <span class="op">+</span> y</a></code></pre></div>
<p>上の例では、元のソースと同じコードが表示されました。</p>
<h4 id="リネーム後"><span class="link-to-here-outer"><a href="#リネーム後" title="リネーム後"><span class="link-to-here">Link to<br />
here</span></a></span>リネーム後</h4>
<p>以下は、リネームのステージ直後のコードを出力する、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/debugging.html?highlight=#ghc-flag--ddump-rn"><code>-ddump-rn</code></a>オプションの例です。</p>
<pre><code>$ ghc -fforce-recomp -ddump-rn Func1.hs </code></pre>
<p>以下の様に出力されます。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1">[<span class="dv">1</span> <span class="kw">of</span> <span class="dv">1</span>] <span class="dt">Compiling</span> <span class="dt">Func1</span>            ( Func1.hs, Func1.o )</a>
<a class="sourceLine" id="cb15-2" title="2"></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="op">====================</span> <span class="dt">Renamer</span> <span class="op">====================</span></a>
<a class="sourceLine" id="cb15-4" title="4">Func1.f1<span class="ot"> ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb15-5" title="5">Func1.f1 x_aRf y_aRg <span class="ot">=</span> x_aRf <span class="op">+</span> y_aRg</a></code></pre></div>
<p>上の例では、ユニークな識別子に変換されたコードが出力されています。<br />
なお、上の例では、ソースファイルの最終更新時刻が、オブジェクトファイルよりも古い場合でも強制的に再コンパイルさせる<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/separate_compilation.html?highlight=#ghc-flag--fforce-recomp"><code>-fforce-recomp</code></a>を指定しています。</p>
<p>以下、いくつかのステージ後の中間コードの出力例を、続けて示します。</p>
<h4 id="脱糖desugar後のcore言語コード"><span class="link-to-here-outer"><a href="#脱糖desugar後のcore言語コード" title="脱糖desugar後のcore言語コード"><span class="link-to-here">Link to<br />
here</span></a></span>脱糖<span class="ascii">(Desugar)</span>後の、<span class="ascii">Core</span>言語コード</h4>
<pre><code>$ ghc -O -fforce-recomp -ddump-ds Func1.hs</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" title="1">  <span class="op">:</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="ot">f1 ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb17-3" title="3">[<span class="dt">LclIdX</span>]</a>
<a class="sourceLine" id="cb17-4" title="4">f1</a>
<a class="sourceLine" id="cb17-5" title="5">  <span class="ot">=</span> \ (<span class="ot">x_aSt ::</span> <span class="dt">Int</span>) (<span class="ot">y_aSu ::</span> <span class="dt">Int</span>) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb17-6" title="6">      <span class="op">+</span> <span class="op">@</span> <span class="dt">Int</span> <span class="op">GHC.Num.$</span>fNumInt x_aSt y_aSu</a>
<a class="sourceLine" id="cb17-7" title="7">  <span class="op">:</span></a></code></pre></div>
<p>上の例では、<span class="ascii">Haskell</span>言語の構文から、<span class="ascii">GHC</span>の内部表現の１つである<span class="ascii">Core</span>言語に変換されたコードが出力されています。<br />
<span class="ascii">Core</span>言語は、非常にシンプルな要素で構成された関数型言語です。</p>
<h4 id="stg中間言語での最適化最終コード"><span class="link-to-here-outer"><a href="#stg中間言語での最適化最終コード" title="stg中間言語での最適化最終コード"><span class="link-to-here">Link to<br />
here</span></a></span><span class="ascii">STG</span>中間言語での最適化最終コード</h4>
<pre><code>$ ghc -O -fforce-recomp -ddump-stg Func1.hs</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" title="1">  <span class="op">:</span></a>
<a class="sourceLine" id="cb19-2" title="2">Func1.f1<span class="ot"> ::</span> <span class="dt">GHC.Types.Int</span> <span class="ot">-&gt;</span> <span class="dt">GHC.Types.Int</span> <span class="ot">-&gt;</span> <span class="dt">GHC.Types.Int</span></a>
<a class="sourceLine" id="cb19-3" title="3">[<span class="dt">GblId</span>,</a>
<a class="sourceLine" id="cb19-4" title="4"> <span class="dt">Arity</span><span class="ot">=</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb19-5" title="5"> <span class="dt">Caf</span><span class="ot">=</span><span class="dt">NoCafRefs</span>,</a>
<a class="sourceLine" id="cb19-6" title="6"> <span class="dt">Str</span><span class="op">=&lt;</span><span class="dt">S</span>(<span class="dt">S</span>),<span class="dv">1</span><span class="op">*</span><span class="dt">U</span>(<span class="dt">U</span>)<span class="op">&gt;&lt;</span><span class="dt">S</span>(<span class="dt">S</span>),<span class="dv">1</span><span class="op">*</span><span class="dt">U</span>(<span class="dt">U</span>)<span class="op">&gt;</span>m,</a>
<a class="sourceLine" id="cb19-7" title="7"> <span class="dt">Unf</span><span class="ot">=</span><span class="dt">OtherCon</span> []] <span class="ot">=</span></a>
<a class="sourceLine" id="cb19-8" title="8">    \r [eta_B2 eta_B1] <span class="op">GHC.Num.$</span>fNumInt_<span class="op">$</span>c<span class="op">+</span> eta_B2 eta_B1;</a>
<a class="sourceLine" id="cb19-9" title="9">  <span class="op">:</span></a></code></pre></div>
<p>上の例では、さらに、<span class="ascii">GHC</span>の内部表現の１つである<span class="ascii">STG</span>言語に変換されたコードが出力されています。<br />
<span class="ascii">STG</span>言語は、非常にシンプルな要素で構成された、<span class="ascii">GHC</span>の動作モデルと結びついた関数型言語です。</p>
<h4 id="cmm中間言語での最適化最終コード"><span class="link-to-here-outer"><a href="#cmm中間言語での最適化最終コード" title="cmm中間言語での最適化最終コード"><span class="link-to-here">Link to<br />
here</span></a></span><span class="ascii">Cmm</span>中間言語での最適化最終コード</h4>
<pre><code>$ ghc -O -fforce-recomp -ddump-opt-cmm Func1.hs</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" title="1">  <span class="op">:</span></a>
<a class="sourceLine" id="cb21-2" title="2">Func1.f1_entry() <span class="op">//</span>  [<span class="dt">R3</span>, <span class="dt">R2</span>]</a>
<a class="sourceLine" id="cb21-3" title="3">        { [(c15y,</a>
<a class="sourceLine" id="cb21-4" title="4">            Func1.f1_info<span class="op">:</span></a>
<a class="sourceLine" id="cb21-5" title="5">                <span class="fu">const</span> <span class="dv">8589934607</span>;</a>
<a class="sourceLine" id="cb21-6" title="6">                <span class="fu">const</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb21-7" title="7">                <span class="fu">const</span> <span class="dv">14</span>;)]</a>
<a class="sourceLine" id="cb21-8" title="8">        }</a>
<a class="sourceLine" id="cb21-9" title="9">    {offset</a>
<a class="sourceLine" id="cb21-10" title="10">      c15y<span class="op">:</span> <span class="op">//</span> global</a>
<a class="sourceLine" id="cb21-11" title="11">          <span class="op">//</span> nop</a>
<a class="sourceLine" id="cb21-12" title="12">          <span class="op">//</span> nop</a>
<a class="sourceLine" id="cb21-13" title="13">          call <span class="op">GHC.Num.$</span>fNumInt_<span class="op">$</span>c<span class="op">+</span>_info(<span class="dt">R3</span>, <span class="dt">R2</span>) args<span class="op">:</span> <span class="dv">8</span>, res<span class="op">:</span> <span class="dv">0</span>, upd<span class="op">:</span> <span class="dv">8</span>;</a>
<a class="sourceLine" id="cb21-14" title="14">    }</a>
<a class="sourceLine" id="cb21-15" title="15">}</a>
<a class="sourceLine" id="cb21-16" title="16">  <span class="op">:</span></a></code></pre></div>
<p>上の例では、さらに、<span class="ascii">GHC</span>の内部表現の１つである<span class="ascii">Cmm</span>言語に変換されたコードが出力されています。<br />
<span class="ascii">Cmm(C minus minus)</span>言語は、<span class="ascii">C</span>言語とアセンブリ言語の中間的な位置づけの、手続き型言語です。</p>
<h4 id="最終アセンブリ命令列"><span class="link-to-here-outer"><a href="#最終アセンブリ命令列" title="最終アセンブリ命令列"><span class="link-to-here">Link to<br />
here</span></a></span>最終アセンブリ命令列</h4>
<pre><code>$ ghc -O -fforce-recomp -ddump-asm Func1.hs</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb23-1" title="1">  <span class="op">:</span></a>
<a class="sourceLine" id="cb23-2" title="2"><span class="op">.</span>globl Func1.f1_info</a>
<a class="sourceLine" id="cb23-3" title="3"><span class="op">.</span><span class="kw">type</span> Func1.f1_info, <span class="op">@</span>object</a>
<a class="sourceLine" id="cb23-4" title="4">Func1.f1_info<span class="op">:</span></a>
<a class="sourceLine" id="cb23-5" title="5">_c15y<span class="op">:</span></a>
<a class="sourceLine" id="cb23-6" title="6">	jmp <span class="op">GHC.Num.$</span>fNumInt_<span class="op">$</span>c<span class="op">+</span>_info</a>
<a class="sourceLine" id="cb23-7" title="7">  <span class="op">:</span></a></code></pre></div>
<p>上の例では、最終的なターゲット<span class="ascii">CPU</span>用のアセンブリ言語の命令コードが出力されています。</p>
<p>詳細は省略しますが、他にも様々なステージの情報を出力させることが出来ます。</p>
<ul>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/debugging.html?highlight=#ghc-flag--ddump-simpl"><code>-ddump-simpl</code></a> <span class="ascii">: Core</span>中間言語での最適化中コード</li>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/debugging.html?highlight=#ghc-flag--ddump-prep"><code>-ddump-prep</code></a> <span class="ascii">: Core</span>中間言語での最適化最終コード</li>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/debugging.html?highlight=#ghc-flag--ddump-cmm"><code>-ddump-cmm</code></a> <span class="ascii">: Cmm</span>中間言語での最適化中コード</li>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/debugging.html?highlight=#ghc-flag--ddump-llvm"><code>-ddump-llvm</code></a> <span class="ascii">: LLVM</span>版の命令列</li>
<li>その他</li>
</ul>
<p>中間コードの出力方法の詳細は、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/debugging.html?highlight=#dumping-out-compiler-intermediate-structures">こちら</a>を参照してください。<br />
中間言語については、<a href="http://www.kotha.net/hperf/ghc.html">こちら</a>も参考になります。</p>
<h3 id="型情報の出力"><span class="link-to-here-outer"><a href="#型情報の出力" title="型情報の出力"><span class="link-to-here">Link to<br />
here</span></a></span>型情報の出力</h3>
<p>コンパイル時に得られる型情報を出力することが出来ます。<br />
例えば、以下の単純なソースの場合について例を示します。</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb24-1" title="1"><span class="op">$</span> cat Func2.hs</a>
<a class="sourceLine" id="cb24-2" title="2"></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="kw">module</span> <span class="dt">Func2</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb24-4" title="4"></a>
<a class="sourceLine" id="cb24-5" title="5"><span class="kw">type</span> <span class="dt">Count</span> <span class="ot">=</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb24-6" title="6"></a>
<a class="sourceLine" id="cb24-7" title="7"><span class="ot">f2 ::</span> <span class="dt">Count</span> <span class="ot">-&gt;</span> <span class="dt">Count</span> <span class="ot">-&gt;</span> <span class="dt">Count</span></a>
<a class="sourceLine" id="cb24-8" title="8">f2 a b <span class="ot">=</span> a <span class="op">+</span> b</a></code></pre></div>
<p>コンパイル時に得られる型情報を出力するには、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/debugging.html?highlight=#ghc-flag--ddump-types"><code>-ddump-types</code></a>オプションを指定します。</p>
<pre><code>$ ghc -ddump-types Func2.hs</code></pre>
<p>以下の様に出力されます。</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb26-1" title="1">[<span class="dv">1</span> <span class="kw">of</span> <span class="dv">1</span>] <span class="dt">Compiling</span> <span class="dt">Func2</span>            ( Func2.hs, Func2.o )</a>
<a class="sourceLine" id="cb26-2" title="2"><span class="dt">TYPE</span> <span class="dt">SIGNATURES</span></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="ot">  f2 ::</span> <span class="dt">Count</span> <span class="ot">-&gt;</span> <span class="dt">Count</span> <span class="ot">-&gt;</span> <span class="dt">Count</span></a>
<a class="sourceLine" id="cb26-4" title="4"><span class="dt">TYPE</span> <span class="dt">CONSTRUCTORS</span></a>
<a class="sourceLine" id="cb26-5" title="5">  <span class="kw">type</span> <span class="dt">Count</span> <span class="ot">=</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb26-6" title="6"><span class="dt">COERCION</span> <span class="dt">AXIOMS</span></a>
<a class="sourceLine" id="cb26-7" title="7"><span class="dt">Dependent</span> modules<span class="op">:</span> []</a>
<a class="sourceLine" id="cb26-8" title="8"><span class="dt">Dependent</span> packages<span class="op">:</span> [base<span class="op">-</span><span class="fl">4.10</span><span class="op">.</span><span class="fl">0.0</span>, ghc<span class="op">-</span>prim<span class="op">-</span><span class="fl">0.5</span><span class="op">.</span><span class="fl">1.0</span>,</a>
<a class="sourceLine" id="cb26-9" title="9">                     integer<span class="op">-</span>gmp<span class="op">-</span><span class="fl">1.0</span><span class="op">.</span><span class="fl">1.0</span>]</a></code></pre></div>
<p>それぞれの型の情報が出力されています。</p>
<h3 id="正格性情報の出力"><span class="link-to-here-outer"><a href="#正格性情報の出力" title="正格性情報の出力"><span class="link-to-here">Link to<br />
here</span></a></span>正格性情報の出力</h3>
<p>コンパイル時に得られる正格性についての情報を出力することが出来ます。<br />
例えば、以下の単純なソースの場合について例を示します。<br />
少し恣意的な例ですが、関数<span class="ascii">f3</span>の第１引数は正格（かつ関数内で使用されている）、第<span class="ascii">2</span>引数は非正格（かつ関数内で使用されている）、第<span class="ascii">3</span>引数は非正格（かつ関数内で使用されていない）という場合の例です。</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb27-1" title="1"><span class="op">$</span> cat Func3.hs </a>
<a class="sourceLine" id="cb27-2" title="2"></a>
<a class="sourceLine" id="cb27-3" title="3"><span class="kw">module</span> <span class="dt">Func3</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb27-4" title="4"></a>
<a class="sourceLine" id="cb27-5" title="5"><span class="ot">f3 ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb27-6" title="6">f3 <span class="dv">0</span> y z <span class="ot">=</span> <span class="op">-</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb27-7" title="7">f3 x y z <span class="ot">=</span> <span class="fu">abs</span> y</a></code></pre></div>
<p>コンパイル時に得られる、関数の各引数についての正格性の情報を出力するには、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/debugging.html?highlight=#ghc-flag--ddump-str-signatures"><code>-ddump-str-signatures</code></a>オプションを指定します。 なお、正格性についての最適化を行うために、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/using-optimisation.html?highlight=#ghc-flag--O"><code>-O</code></a>オプションも併せて指定します。</p>
<pre><code>$ ghc -O -ddump-str-signatures Func3.hs</code></pre>
<p>正格性についての情報が、以下の様に出力されます。</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb29-1" title="1">[<span class="dv">1</span> <span class="kw">of</span> <span class="dv">1</span>] <span class="dt">Compiling</span> <span class="dt">Func3</span>            ( Func3.hs, Func3.o )</a>
<a class="sourceLine" id="cb29-2" title="2"></a>
<a class="sourceLine" id="cb29-3" title="3"><span class="op">====================</span> <span class="dt">Strictness</span> signatures <span class="op">====================</span></a>
<a class="sourceLine" id="cb29-4" title="4"><span class="dt">Func3</span><span class="op">.$</span>trModule<span class="op">:</span> m</a>
<a class="sourceLine" id="cb29-5" title="5">Func3.f3<span class="op">:</span> <span class="op">&lt;</span><span class="dt">S</span>(<span class="dt">S</span>),<span class="dv">1</span><span class="op">*</span><span class="dt">U</span>(<span class="dv">1</span><span class="op">*</span><span class="dt">U</span>)<span class="op">&gt;&lt;</span><span class="dt">L</span>,<span class="dv">1</span><span class="op">*</span><span class="dt">U</span>(<span class="dt">U</span>)<span class="op">&gt;&lt;</span><span class="dt">L</span>,<span class="dt">A</span><span class="op">&gt;</span>m</a>
<a class="sourceLine" id="cb29-6" title="6"></a>
<a class="sourceLine" id="cb29-7" title="7"></a>
<a class="sourceLine" id="cb29-8" title="8"></a>
<a class="sourceLine" id="cb29-9" title="9"><span class="op">====================</span> <span class="dt">Strictness</span> signatures <span class="op">====================</span></a>
<a class="sourceLine" id="cb29-10" title="10"><span class="dt">Func3</span><span class="op">.$</span>trModule<span class="op">:</span> m</a>
<a class="sourceLine" id="cb29-11" title="11">Func3.f3<span class="op">:</span> <span class="op">&lt;</span><span class="dt">S</span>(<span class="dt">S</span>),<span class="dv">1</span><span class="op">*</span><span class="dt">U</span>(<span class="dv">1</span><span class="op">*</span><span class="dt">U</span>)<span class="op">&gt;&lt;</span><span class="dt">L</span>,<span class="dv">1</span><span class="op">*</span><span class="dt">U</span>(<span class="dt">U</span>)<span class="op">&gt;&lt;</span><span class="dt">L</span>,<span class="dt">A</span><span class="op">&gt;</span>m</a></code></pre></div>
<p>上の例によると、第１引数は、<code>&lt;S(S),1*U(1*U)&gt;</code>の部分により表されています。 ここでの<code>S(S)</code>は、引数が正格<span class="ascii">(Strict)</span>であることを示しています。 <code>1*U(1*U)</code>は、引数が関数内で使用<span class="ascii">(Use)</span>されていることを示しています。<br />
第<span class="ascii">2</span>引数は、<code>&lt;L,1*U(U)&gt;</code>の部分により表されています。 <code>L</code>は引数が非正格（<span class="ascii">non-strict</span>）であることを示しています。 <code>1*U(U)</code>は、引数が関数内で使用<span class="ascii">(Use)</span>されていることを示しています。<br />
第<span class="ascii">3</span>引数は、<code>&lt;L,A&gt;</code>の部分により表されています。 <code>L</code>は引数が非正格（<span class="ascii">non-strict</span>）であることを示しています。 <code>A</code>は、引数が関数内で不使用（<span class="ascii">Absence</span>）であることを示しています。</p>
<p>正格性解析については、<a href="https://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/Demand">こちら</a>も参考になります。</p>
<h3 id="その他コンパイル時のいろいろなオプション"><span class="link-to-here-outer"><a href="#その他コンパイル時のいろいろなオプション" title="その他コンパイル時のいろいろなオプション"><span class="link-to-here">Link to<br />
here</span></a></span>その他、コンパイル時のいろいろなオプション</h3>
<p>他にも、コンパイル時に様々な情報を出力させることが出来ます。</p>
<ul>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/using-warnings.html?highlight=#ghc-flag--Wall"><code>-Wall</code></a> <span class="ascii">:</span> コンパイル時に<span class="ascii">Warning</span>情報を出力</li>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/using.html?highlight=#ghc-flag--v"><code>-v</code></a> <span class="ascii">:</span> コンパイル時にコンパイラの詳細情報を出力</li>
</ul>
<p>コンパイル時のオプションの詳細は、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/flags.html#flag-reference">こちら</a>を参照してください。</p>
<hr />
<h2 id="ch3"><span class="link-to-here-outer"><a href="#ch3" title="ch3"><span class="link-to-here">Link to<br />
here</span></a></span><span class="ascii">3.</span> 実行オブジェクトの実行時における情報の出力方法</h2>
<p>ここでは、<span class="ascii">GHC</span>によりコンパイルされた実行オブジェクトについて、実行時に情報を出力する方法を紹介します。</p>
<ul>
<li>実行時の統計情報の出力</li>
<li>時間プロファイルの出力</li>
<li>空間プロファイルの出力</li>
<li>実行時イベントの出力</li>
<li>コードカバレッジの出力</li>
<li>スタックトレースの出力</li>
</ul>
<p>以下、各々の例について説明します。</p>
<h3 id="実行時の統計情報の出力"><span class="link-to-here-outer"><a href="#実行時の統計情報の出力" title="実行時の統計情報の出力"><span class="link-to-here">Link to<br />
here</span></a></span>実行時の統計情報の出力</h3>
<p><span class="ascii">GHC</span>によりコンパイルされた実行オブジェクトについて、実行時の統計情報を出力できます。<br />
例えば、以下のソースの場合について例を示します。</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb30-1" title="1"><span class="op">$</span> cat Prog1.hs</a>
<a class="sourceLine" id="cb30-2" title="2"></a>
<a class="sourceLine" id="cb30-3" title="3"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb30-4" title="4"></a>
<a class="sourceLine" id="cb30-5" title="5"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb30-6" title="6">main <span class="ot">=</span> <span class="fu">print</span> <span class="op">$</span> <span class="fu">sum</span> [<span class="dv">1</span><span class="op">..</span><span class="dv">10000000</span>]</a></code></pre></div>
<p>まずは、普通にコンパイルを行います。<br />
ここでは、通常の例を示すために、標準的な最適化を行う<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/using-optimisation.html?highlight=#ghc-flag--O"><code>-O</code></a>オプションを指定しています（プロファイル取得に必須ではありません。）</p>
<pre><code>$ ghc -O Prog1.hs </code></pre>
<p>実行時の統計情報を出力するには、以下の様に、実行オブジェクトの起動時に<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/runtime_control.html#setting-rts-options-on-the-command-line"><code>+RTS</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/runtime_control.html?highlight=#rts-options-to-produce-runtime-statistics"><code>-s</code></a>オプションを指定します。 （<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/runtime_control.html#setting-rts-options-on-the-command-line"><code>+RTS</code></a>以降の引数が、<span class="ascii">GHC</span>のランタイムシステム<span class="ascii">(RTS)</span>に引き渡されます。 ここでは、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/runtime_control.html?highlight=#rts-options-to-produce-runtime-statistics"><code>-s</code></a>が統計情報出力のためのオプションです。）</p>
<pre><code>$ ./Prog1 +RTS -s</code></pre>
<p>以下の様に、実行時の統計情報が出力されます。</p>
<pre><code>50000005000000
     320,051,552 bytes allocated in the heap
          23,320 bytes copied during GC
          44,504 bytes maximum residency (2 sample(s))
          29,224 bytes maximum slop
               2 MB total memory in use (0 MB lost due to fragmentation)

                                     Tot time (elapsed)  Avg pause  Max pause
  Gen  0       304 colls,     0 par    0.004s   0.004s     0.0000s    0.0002s
  Gen  1         2 colls,     0 par    0.000s   0.000s     0.0000s    0.0000s

  INIT    time    0.000s  (  0.000s elapsed)
  MUT     time    0.532s  (  0.549s elapsed)
  GC      time    0.004s  (  0.004s elapsed)
  EXIT    time    0.000s  (  0.000s elapsed)
  Total   time    0.536s  (  0.553s elapsed)

  %GC     time       0.7%  (0.7% elapsed)

  Alloc rate    601,600,661 bytes per MUT second

  Productivity  99.3% of total user, 99.3% of total elapsed</code></pre>
<p>上の例では、全体の実行時間やヒープの割当量や<span class="ascii">GC</span>の概況等が出力されています。</p>
<p>表示内容の詳細については、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/runtime_control.html?highlight=#rts-options-to-produce-runtime-statistics">こちら</a>を参照してください。</p>
<h3 id="時間プロファイルの出力"><span class="link-to-here-outer"><a href="#時間プロファイルの出力" title="時間プロファイルの出力"><span class="link-to-here">Link to<br />
here</span></a></span>時間プロファイルの出力</h3>
<p><span class="ascii">GHC</span>によりコンパイルされた実行オブジェクトについて、実行時の時間プロファイル情報を出力できます。<br />
例えば、以下のソースの場合について例を示します。</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb34-1" title="1"><span class="op">$</span> cat Prog2.hs</a>
<a class="sourceLine" id="cb34-2" title="2"></a>
<a class="sourceLine" id="cb34-3" title="3"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb34-4" title="4"></a>
<a class="sourceLine" id="cb34-5" title="5"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb34-6" title="6">main <span class="ot">=</span> <span class="fu">print</span> f1</a>
<a class="sourceLine" id="cb34-7" title="7"></a>
<a class="sourceLine" id="cb34-8" title="8"><span class="ot">f1 ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb34-9" title="9">f1 <span class="ot">=</span> <span class="fu">sum</span> [<span class="dv">1</span><span class="op">..</span><span class="dv">10000000</span>] <span class="op">+</span> f2</a>
<a class="sourceLine" id="cb34-10" title="10"></a>
<a class="sourceLine" id="cb34-11" title="11"><span class="ot">f2 ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb34-12" title="12">f2 <span class="ot">=</span> <span class="fu">sum</span> [<span class="dv">1</span><span class="op">..</span><span class="dv">10000000</span>]</a></code></pre></div>
<p>プロファイルを取るためには、以下の様にまず、コンパイル時に、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/phases.html?highlight=#ghc-flag--rtsopts%5B=%E2%9F%A8none%7Csome%7Call%E2%9F%A9%5D"><code>-rtsopts</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--prof"><code>-prof</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--fprof-auto"><code>-fprof-auto</code></a>オプションを指定します。<br />
<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/phases.html?highlight=#ghc-flag--rtsopts%5B=%E2%9F%A8none%7Csome%7Call%E2%9F%A9%5D"><code>-rtsopts</code></a>は、実行オブジェクトの実行時に、<span class="ascii">GHC</span>のランタイムシステム<span class="ascii">(RTS)</span>用の引数を使用可能にするオプションです。 <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--prof"><code>-prof</code></a>は、プロファイル用のコードを埋め込むためのオプションです。 <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--fprof-auto"><code>-fprof-auto</code></a>は、プロファイルを取得する対象を自動で設定するオプションです。</p>
<pre><code>$ ghc -O -rtsopts -prof -fprof-auto Prog2.hs</code></pre>
<p>実行時の時間プロファイルを出力するには、実行オブジェクトの起動時に<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/runtime_control.html#setting-rts-options-on-the-command-line"><code>+RTS</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#rts-flag--p"><code>-p</code></a>オプションを指定します。 （<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#rts-flag--p"><code>-p</code></a>が時間プロファイル情報出力のためのオプションです。）</p>
<pre><code>$ ./Prog2 +RTS -p</code></pre>
<p>これにより、時間プロファイル情報が、<code>Prog2.prof</code>ファイルに以下の様に出力されます。</p>
<pre><code>$ cat Prog2.prof
	Sun Sep  3 18:01 2017 Time and Allocation Profiling Report  (Final)

	   Prog2 +RTS -p -RTS

	total time  =        0.03 secs   (25 ticks @ 1000 us, 1 processor)
	total alloc =      49,688 bytes  (excludes profiling overheads)

COST CENTRE MODULE           SRC               %time %alloc

f2          Main             Prog2.hs:11:1-22   60.0    0.0
f1          Main             Prog2.hs:8:1-27    40.0    0.1
MAIN        MAIN             &lt;built-in&gt;          0.0    1.3
CAF         GHC.IO.Handle.FD &lt;entire-module&gt;     0.0   69.8
CAF         GHC.IO.Encoding  &lt;entire-module&gt;     0.0    5.6
CAF         GHC.Conc.Signal  &lt;entire-module&gt;     0.0    1.3
main        Main             Prog2.hs:5:1-15     0.0   21.3
 :</code></pre>
<p>上の例では、<span class="ascii">main</span>や<span class="ascii">f1</span>や<span class="ascii">f2</span>などについて、関数ごとの実行時間が出力されています。</p>
<p>時間プロファイルの表示内容の詳細については、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#profiling">こちら</a>を参照してください。<br />
時間プロファイルについては、<a href="http://book.realworldhaskell.org/read/profiling-and-optimization.html#id677833">こちら</a>や、<a href="http://itpro.nikkeibp.co.jp/article/COLUMN/20110201/356705/">こちら</a>も参考になります。</p>
<h3 id="空間プロファイルの出力"><span class="link-to-here-outer"><a href="#空間プロファイルの出力" title="空間プロファイルの出力"><span class="link-to-here">Link to<br />
here</span></a></span>空間プロファイルの出力</h3>
<p><span class="ascii">GHC</span>によりコンパイルされた実行オブジェクトについて、実行時の空間プロファイル情報、つまり、ヒープメモリの使用状況等を出力できます。<br />
例えば、以下のソースの場合について例を示します。</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb38-1" title="1"><span class="op">$</span> cat Prog3.hs</a>
<a class="sourceLine" id="cb38-2" title="2"></a>
<a class="sourceLine" id="cb38-3" title="3"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb38-4" title="4"></a>
<a class="sourceLine" id="cb38-5" title="5"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb38-6" title="6">main <span class="ot">=</span> <span class="fu">print</span> <span class="op">$</span> f1 [<span class="dv">1</span><span class="op">..</span><span class="dv">1000000</span>]</a>
<a class="sourceLine" id="cb38-7" title="7"></a>
<a class="sourceLine" id="cb38-8" title="8">f1 [] <span class="ot">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb38-9" title="9">f1 (x<span class="op">:</span>xs) <span class="ot">=</span> (<span class="fu">abs</span> x) <span class="op">+</span> (f1 xs)</a></code></pre></div>
<p>プロファイルを取るためには、以下の様にまず、コンパイル時に、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/phases.html?highlight=#ghc-flag--rtsopts%5B=%E2%9F%A8none%7Csome%7Call%E2%9F%A9%5D"><code>-rtsopts</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--prof"><code>-prof</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--fprof-auto"><code>-fprof-auto</code></a>オプションを指定します。<br />
<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/phases.html?highlight=#ghc-flag--rtsopts%5B=%E2%9F%A8none%7Csome%7Call%E2%9F%A9%5D"><code>-rtsopts</code></a>は、実行オブジェクトの実行時に、<span class="ascii">GHC</span>のランタイムシステム<span class="ascii">(RTS)</span>用の引数を使用可能にするオプションです。 <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--prof"><code>-prof</code></a>は、プロファイル用のコードを埋め込むためのオプションです。 <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--fprof-auto"><code>-fprof-auto</code></a>は、プロファイルを取得する対象を自動で設定するオプションです。</p>
<p>ここでは、メモリ使用状況を分かりやすくするために、最適化のレベルを下げる<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/using-optimisation.html?highlight=#ghc-flag--O0"><code>-O0</code></a>オプションを指定しています（プロファイル取得に必須ではありません）。</p>
<pre><code>$ ghc -O0 -rtsopts -prof -fprof-auto Prog3.hs</code></pre>
<p>実行時の空間プロファイルを出力するには、実行オブジェクトの起動時に<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/runtime_control.html#setting-rts-options-on-the-command-line"><code>+RTS</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#rts-flag--hc"><code>-hc</code></a>オプションを指定します。 （<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#rts-flag--hc"><code>-hc</code></a>が時間プロファイル情報出力のためのオプションです。）</p>
<pre><code>$ ./Prog3 +RTS -hc -i0.1</code></pre>
<p>これにより、プロファイル情報が、<code>Prog3.hp</code>ファイルに生成されます。</p>
<p>なお、上の例では、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#rts-flag--i"><code>-i</code></a>オプションにより、プロファイルを取得する間隔を秒単位で指定しています。この例では、<span class="ascii">0.1</span>秒単位にプロファイル情報を取得しています。秒数は、状況に併せて調整してください。</p>
<p>さらに、以下の様に、<span class="ascii">GHC</span>に標準で付属している<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=hp2ps#hp2ps-rendering-heap-profiles-to-postscript"><code>hp2ps</code></a>コマンドを実行することにより、生成されたプロファイル情報を、、<span class="ascii">PostScript</span>ファイルに変換できます。</p>
<pre><code>$ hp2ps -e8in -c Prog3.hp</code></pre>
<p>さらに、<span class="ascii">OS</span>プラットフォームに応じたコマンドなどにより、<span class="ascii">PostScript</span>ファイルを<span class="ascii">PDF</span>に変換します。 ここでは、<span class="ascii">ps2pdf</span>コマンドを使用しています。</p>
<pre><code>$ ps2pdf Prog3.ps &gt; Prog3.pdf</code></pre>
<p>これにより、以下の様に、空間プロファイルがグラフィカルに表示されます。</p>
<p><img src="../../img/2017/12-rts-space-profile.png" /></p>
<p>空間プロファイルの表示内容の詳細については、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#profiling-memory-usage">こちら</a>を参照してください。<br />
空間プロファイルについては、<a href="http://book.realworldhaskell.org/read/profiling-and-optimization.html#id678078">こちら</a>や、<a href="https://medium.com/@maoe/ghc%E3%83%92%E3%83%BC%E3%83%97%E3%83%97%E3%83%AD%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%AE%E6%89%8B%E5%BC%95%E3%81%8D-md-bb8d180230f6">こちら</a>も参考になります。</p>
<h3 id="実行時イベントの出力"><span class="link-to-here-outer"><a href="#実行時イベントの出力" title="実行時イベントの出力"><span class="link-to-here">Link to<br />
here</span></a></span>実行時イベントの出力</h3>
<p><span class="ascii">GHC</span>によりコンパイルされた実行オブジェクトについて、実行時のイベント情報を出力できます。<br />
実行時のイベントとは、<span class="ascii">GHC</span>のランタイムシステム（<span class="ascii">RTS</span>）におけるスレッドスケジューラや<span class="ascii">GC</span>などの動作情報や、ユーザー指定による動作情報です。<br />
例えば、以下のソースの場合について例を示します。</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb43-1" title="1"><span class="op">$</span> cat Prog4.hs</a>
<a class="sourceLine" id="cb43-2" title="2"></a>
<a class="sourceLine" id="cb43-3" title="3"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb43-4" title="4"></a>
<a class="sourceLine" id="cb43-5" title="5"><span class="kw">import</span> <span class="dt">Control.Concurrent</span> (forkIO, threadDelay, myThreadId)</a>
<a class="sourceLine" id="cb43-6" title="6"></a>
<a class="sourceLine" id="cb43-7" title="7"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb43-8" title="8">main <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb43-9" title="9">    forkIO sub</a>
<a class="sourceLine" id="cb43-10" title="10">    forkIO sub</a>
<a class="sourceLine" id="cb43-11" title="11">    threadDelay (<span class="dv">2</span> <span class="op">*</span> <span class="dv">1000</span> <span class="op">*</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb43-12" title="12"></a>
<a class="sourceLine" id="cb43-13" title="13"><span class="ot">sub ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb43-14" title="14">sub <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb43-15" title="15">    myThreadId <span class="op">&gt;&gt;=</span> <span class="fu">print</span></a>
<a class="sourceLine" id="cb43-16" title="16">    <span class="fu">print</span> <span class="op">$</span> <span class="fu">sum</span> [<span class="dv">1</span><span class="op">..</span><span class="dv">100000</span>]</a></code></pre></div>
<p>実行時イベントを出力するためには、以下の様にまず、コンパイル時に、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/phases.html?highlight=#ghc-flag--rtsopts%5B=%E2%9F%A8none%7Csome%7Call%E2%9F%A9%5D"><code>-rtsopts</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/phases.html#ghc-flag--eventlog"><code>-eventlog</code></a>オプションを指定します。<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/phases.html#ghc-flag--eventlog"><code>-eventlog</code></a>が、イベントログを出力するためのオプションです。</p>
<pre><code>$ ghc -O -rtsopts -eventlog Prog4.hs</code></pre>
<p>さらに、実際に実行時イベントを出力するには、実行オブジェクトの起動時に<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/runtime_control.html#setting-rts-options-on-the-command-line"><code>+RTS</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#rts-flag--l"><code>-l</code></a>オプションを指定します。 （<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#rts-flag--l"><code>-l</code></a>が実行時イベントを出力するためのオプションです。）</p>
<pre><code>$ ./Prog4 +RTS -l</code></pre>
<p>これにより、実行時のイベント情報が、<code>Prog4.eventlog</code>ファイルにバイナリ形式で出力されます。<br />
バイナリ形式の出力を表示するには２種類の方法があります。 <span class="ascii">Threadscope</span>コマンドにより<span class="ascii">GUI</span>で表示する方法と、<span class="ascii">ghc-events</span>コマンドによりテキスト形式で表示する方法です。 どちらも、コマンドを別途インストールする必要があります。</p>
<h4 id="threadscopeによるgui表示"><span class="link-to-here-outer"><a href="#threadscopeによるgui表示" title="threadscopeによるgui表示"><span class="link-to-here">Link to<br />
here</span></a></span><span class="ascii">ThreadScope</span>による<span class="ascii">GUI</span>表示</h4>
<p>以下は、１つめの方法である<span class="ascii">ThreadScope</span>を用いた表示例です。<br />
まず、<a href="https://github.com/haskell/ThreadScope/releases/">こちら</a>から<code>threadscope</code>のバイナリを入手するか、以下の方法により、<code>threadscope</code>コマンドをインストールしてください。</p>
<pre><code>$ stack install threadScope</code></pre>
<p>そして、以下のコマンドにより<span class="ascii">Threadscope</span>を起動します。</p>
<pre><code>$ threadscope Prog4.eventlog</code></pre>
<p>以下の様に<span class="ascii">GUI</span>が起動し、スレッドの稼動状態や<span class="ascii">GC</span>の状態を可視化できます。</p>
<p><img src="../../img/2017/12-rts-threadscope.png" /></p>
<p>上の例では、緑の部分がスレッドの稼働中、橙の部分が<span class="ascii">GC</span>の稼働中を表しています。 また、同時に１つスレッドのみが稼働していることが分かります（物理<span class="ascii">CPU</span>が１個に制限されたハードウェアでの実行例です。）</p>
<h4 id="ghc-eventsによるテキスト表示"><span class="link-to-here-outer"><a href="#ghc-eventsによるテキスト表示" title="ghc-eventsによるテキスト表示"><span class="link-to-here">Link to<br />
here</span></a></span><span class="ascii">ghc-events</span>によるテキスト表示</h4>
<p>以下は、２つめの方法である<span class="ascii">ghc-events</span>を用いた表示例です。<br />
まず、以下の方法により、<code>ghc-events</code>コマンドをインストールしてください。</p>
<pre><code>$ stack install ghc-events</code></pre>
<p>そして、以下のコマンドにより、イベントの内容をテキスト形式で表示できます。</p>
<pre><code>$ ghc-events show Prog4.eventlog</code></pre>
<p>以下の様に、テキスト形式でイベント状況が詳細に表示されます。</p>
<pre><code>Event Types:
0: Create thread (size 4)
1: Run thread (size 4)
2: Stop thread (size 10)
3: Thread runnable (size 4)
4: Migrate thread (size 6)
8: Wakeup thread (size 6)
9: Starting GC (size 0)
  :
Events:
132911: created capset 0 of type CapsetOsProcess
134098: created capset 1 of type CapsetClockDomain
135704: created cap 0
136473: assigned cap 0 to capset 0
137241: assigned cap 0 to capset 1
141152: capset 1: wall clock time 1504529318s 220117000ns (unix epoch)
142339: capset 0: pid 4626
144644: capset 0: parent pid 3460
  :
250875: cap 0: creating thread 1
253948: cap 0: running thread 1
276507: cap 0: creating thread 2
277764: cap 0: creating thread 3
281117: cap 0: stopping thread 1 (blocked on threadDelay)
286774: cap 0: running thread 2
334686: cap 0: stopping thread 2 (thread yielding)
337829: cap 0: running thread 3
341321: cap 0: stopping thread 3 (blocked on an MVar)
343975: cap 0: running thread 2
349563: cap 0: waking up thread 3 on cap 0
3108630: cap 0: stopping thread 2 (heap overflow)
  :</code></pre>
<p>上の例では、スレッドの生成や停止の状況が詳細に出力されています。</p>
<p>実行時イベントログ機能の詳細については、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#profiling">こちら</a>を参照してください。<br />
実行時イベントログ機能については、<a href="http://chimera.labs.oreilly.com/books/1230000000929/ch15.html">こちら</a>も参考になります。</p>
<h3 id="コードカバレッジの出力"><span class="link-to-here-outer"><a href="#コードカバレッジの出力" title="コードカバレッジの出力"><span class="link-to-here">Link to<br />
here</span></a></span>コードカバレッジの出力</h3>
<p><span class="ascii">GHC</span>によりコンパイルされた実行オブジェクトについて、実行時のコードカバレッジ情報を出力できます。<br />
例えば、以下のソースの場合について例を示します。</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb51-1" title="1"><span class="op">$</span> cat Prog5.hs</a>
<a class="sourceLine" id="cb51-2" title="2"></a>
<a class="sourceLine" id="cb51-3" title="3"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb51-4" title="4"></a>
<a class="sourceLine" id="cb51-5" title="5"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb51-6" title="6">main <span class="ot">=</span> <span class="fu">print</span> f1</a>
<a class="sourceLine" id="cb51-7" title="7"></a>
<a class="sourceLine" id="cb51-8" title="8">f1 <span class="ot">=</span> f2 <span class="dv">3</span></a>
<a class="sourceLine" id="cb51-9" title="9"></a>
<a class="sourceLine" id="cb51-10" title="10">f2 <span class="dv">3</span> <span class="ot">=</span> f3</a>
<a class="sourceLine" id="cb51-11" title="11">f2 _ <span class="ot">=</span> f4</a>
<a class="sourceLine" id="cb51-12" title="12"></a>
<a class="sourceLine" id="cb51-13" title="13">f3 <span class="ot">=</span> <span class="dv">30</span></a>
<a class="sourceLine" id="cb51-14" title="14">f4 <span class="ot">=</span> <span class="dv">40</span></a></code></pre></div>
<p>コードカバレッジを取得するためには、以下の様にまず、コンパイル時に、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--fhpc"><code>-fhpc</code></a>オプションを指定します。</p>
<pre><code>$ ghc -fhpc Prog5.hs</code></pre>
<p>さらに、コンパイルされた実行オブジェクトを起動するだけで、実行時のコードカバレッジを出力できます。</p>
<pre><code>$ ./Prog5</code></pre>
<p>これにより、コードカバレッジ情報が、<code>Prog5.tix</code>ファイルにバイナリ形式で出力されています。</p>
<p>さらに、以下の様に、<span class="ascii">GHC</span>に標準で付属している<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=hpc#hpc-report"><code>hpc report</code></a>コマンドを実行することで、コードカバレッジの概況をテキスト形式で出力できます。</p>
<pre><code>$ hpc report Prog5</code></pre>
<p>以下の様に、コードカバレッジの概況がテキスト形式で出力されます。</p>
<pre><code> 75% expressions used (6/8)
100% boolean coverage (0/0)
     100% guards (0/0)
     100% 'if' conditions (0/0)
     100% qualifiers (0/0)
 50% alternatives used (1/2)
100% local declarations used (0/0)
 80% top-level declarations used (4/5)</code></pre>
<p>また、以下の様に、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=hpc#hpc-markup"><code>hpc markup</code></a>コマンドを実行することで、<span class="ascii">HTML</span>ファイルの形式で情報を出力することもできます。</p>
<pre><code>$ hpc markup Prog5</code></pre>
<p>以下の様に、モジュールごとに詳細な<span class="ascii">HTML</span>ファイルが生成されます。</p>
<pre><code>$ ls *html
Main.hs.html    hpc_index_alt.html  hpc_index_fun.html
hpc_index.html  hpc_index_exp.html</code></pre>
<p>生成された<span class="ascii">HTML</span>ファイルでは、モジュールごとの概況が以下の様に表示されます。</p>
<p><img src="../../img/2017/12-rts-coverage1.png" /></p>
<p>さらに、モジュール内の詳細状況も以下の様に表示されます。</p>
<p><img src="../../img/2017/12-rts-coverage2.png" /></p>
<p>上の例では、<span class="ascii">f4</span>は、評価（実行）されていないパスである事が分かります。</p>
<p>コードカバレッジの詳細については、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=coverage#observing-code-coverage">こちら</a>を参照してください。<br />
コードカバレッジについては、<a href="http://book.realworldhaskell.org/read/testing-and-quality-assurance.html#id629497">こちら</a>も参考になります。</p>
<h3 id="スタックトレースの出力"><span class="link-to-here-outer"><a href="#スタックトレースの出力" title="スタックトレースの出力"><span class="link-to-here">Link to<br />
here</span></a></span>スタックトレースの出力</h3>
<p><span class="ascii">GHC</span>によりコンパイルされた実行オブジェクトについて、実行時のエラー発生時のスタックトレース情報を出力できます。<br />
例えば、以下のソースの場合について例を示します。</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb58-1" title="1"><span class="op">$</span> cat Prog6.hs</a>
<a class="sourceLine" id="cb58-2" title="2"></a>
<a class="sourceLine" id="cb58-3" title="3"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb58-4" title="4"></a>
<a class="sourceLine" id="cb58-5" title="5"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb58-6" title="6">main <span class="ot">=</span> <span class="fu">print</span> f1</a>
<a class="sourceLine" id="cb58-7" title="7"></a>
<a class="sourceLine" id="cb58-8" title="8">f1 <span class="ot">=</span> f2 <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb58-9" title="9"></a>
<a class="sourceLine" id="cb58-10" title="10">f2 <span class="ot">=</span> f3 <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb58-11" title="11"></a>
<a class="sourceLine" id="cb58-12" title="12">f3 <span class="ot">=</span> <span class="dv">1</span> <span class="ot">`div`</span> <span class="dv">0</span></a></code></pre></div>
<p>スタックトレースを取るためには、以下の様にまず、コンパイル時に、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/phases.html?highlight=#ghc-flag--rtsopts%5B=%E2%9F%A8none%7Csome%7Call%E2%9F%A9%5D"><code>-rtsopts</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--prof"><code>-prof</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--fprof-auto"><code>-fprof-auto</code></a>オプションを指定します。<br />
<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/phases.html?highlight=#ghc-flag--rtsopts%5B=%E2%9F%A8none%7Csome%7Call%E2%9F%A9%5D"><code>-rtsopts</code></a>は、実行オブジェクトの実行時に、<span class="ascii">GHC</span>のランタイムシステム<span class="ascii">(RTS)</span>用の引数を使用可能にするオプションです。 <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--prof"><code>-prof</code></a>は、プロファイル用のコードを埋め込むためのオプションです。 <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#ghc-flag--fprof-auto"><code>-fprof-auto</code></a>は、プロファイルを取得する対象を自動で設定するオプションです。</p>
<pre><code>$ ghc -rtsopts -prof -fprof-auto Prog6.hs</code></pre>
<p>実行時におけるエラー時のスタックトレースを出力するには、実行オブジェクトの起動時に<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/runtime_control.html#setting-rts-options-on-the-command-line"><code>+RTS</code></a> <a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#rts-flag--xc"><code>-xc</code></a>オプションを指定します。 （<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html?highlight=#rts-flag--xc"><code>-xc</code></a>がスタックトレース出力のためのオプションです。）</p>
<pre><code>$ ./Prog6 +RTS -xc</code></pre>
<p>これにより、エラー時のスタックトレース情報が、次の様に出力されます。</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb61-1" title="1"><span class="op">***</span> <span class="dt">Exception</span> (reporting due to <span class="op">+</span><span class="dt">RTS</span> <span class="op">-</span>xc)<span class="op">:</span> (<span class="dt">THUNK_STATIC</span>), stack trace<span class="op">:</span> </a>
<a class="sourceLine" id="cb61-2" title="2">  <span class="dt">GHC.Real.CAF</span></a>
<a class="sourceLine" id="cb61-3" title="3">  <span class="op">--&gt;</span> evaluated by<span class="op">:</span> Main.f3,</a>
<a class="sourceLine" id="cb61-4" title="4">  called from <span class="dt">Main.CAF</span></a>
<a class="sourceLine" id="cb61-5" title="5">  <span class="op">--&gt;</span> evaluated by<span class="op">:</span> Main.f2,</a>
<a class="sourceLine" id="cb61-6" title="6">  called from <span class="dt">Main.CAF</span></a>
<a class="sourceLine" id="cb61-7" title="7">  <span class="op">--&gt;</span> evaluated by<span class="op">:</span> Main.f1,</a>
<a class="sourceLine" id="cb61-8" title="8">  called from <span class="dt">Main.CAF</span></a>
<a class="sourceLine" id="cb61-9" title="9">  <span class="op">--&gt;</span> evaluated by<span class="op">:</span> Main.main,</a>
<a class="sourceLine" id="cb61-10" title="10">  called from <span class="dt">Main.CAF</span></a>
<a class="sourceLine" id="cb61-11" title="11"><span class="dt">Prog6</span><span class="op">:</span> divide by zero</a></code></pre></div>
<p>上の例では、エラーは<span class="ascii">f3</span>で発生しており、<span class="ascii">f3</span>は<span class="ascii">f2, f1, main</span>の順に呼び出されてきたことが分かります。</p>
<p>スタックトレースの詳細については、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/runtime_control.html?highlight=#rts-flag--xc">こちら</a>を参照してください。<br />
スタックトレースについては、<a href="http://d.hatena.ne.jp/kazu-yamamoto/20130205/1360051153">こちら</a>も参考になります。</p>
<p>その他、実行時のオプションの詳細は、<a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/runtime_control.html">こちら</a>を参照してください。</p>
<hr />
<h2 id="補足"><span class="link-to-here-outer"><a href="#補足" title="補足"><span class="link-to-here">Link to<br />
here</span></a></span>補足</h2>
<p>さらに、以下の様に、コンパイラ自身についての、情報を出力する方法もあります。</p>
<ul>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/using.html?highlight=#ghc-flag---version"><code>ghc --version</code></a> <span class="ascii">: GHC</span>のバージョンを出力</li>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/using.html?highlight=#ghc-flag---info"><code>ghc --info</code></a> <span class="ascii">: GHC</span>のコンパイラ自身の詳細情報を出力</li>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/using.html?highlight=#ghc-flag---show-options"><code>ghc --show-options</code></a> <span class="ascii">: GHC</span>のオプション一覧を出力</li>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/using.html?highlight=#ghc-flag---supported-extensions"><code>ghc --supported-extensions</code></a> <span class="ascii">: GHC</span>の言語拡張一覧を出力</li>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/using.html?highlight=#ghc-flag---print-libdir"><code>ghc --print-libdir</code></a> <span class="ascii">: GHC</span>が参照するパッケージのディレクトリ一覧を出力</li>
<li><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/packages.html#using-packages"><code>ghc-pkg list</code></a> <span class="ascii">: GHC</span>が参照するパッケージの一覧を出力</li>
</ul>
<p><span class="ascii">Happy Hacking!</span></p>
<p>以上です。</p>
            </div>
        </div>
        <div id="post-navigation" class="row" style="margin-top: 20px;">
            <div class="col-lg-offset-2 col-lg-3 col-md-offset-1 col-md-4 col-xs-4">
                
                <i class="glyphicon glyphicon-chevron-left" aria-hidden="true" style="margin-right: 5px;"></i>
                <a href="../../posts/2017/13-about-kind-system-part2.html" lang="ja">Haskellの種(kind)について (Part 2)</a>
                
            </div>
            <div class="col-lg-2 col-md-2 col-xs-4 text-center">
                <a href="../../" lang="ja">トップに戻る</a>
            </div>
            <div class="col-lg-3 col-md-4 col-xs-4">
                
                <a href="../../posts/2017/11-haskell-newbies-talks.html" style="margin-left: auto;" lang="ja">Haskell-jp現在の活動・目的総ざらい</a>
                <i class="glyphicon glyphicon-chevron-right" aria-hidden="true" style="margin-left: 5px;"></i>
                
            </div>
        </div>
    </div>
</article>



    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://github.com/haskell-jp/blog">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <div class="text-muted notice text-center"> <br /><span class="author">&copy; takenbu.hs 2017</span> <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.ja"><img alt="クリエイティブ・コモンズ・ライセンス" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a></div>
                    <div class="text-muted notice text-center">この作品は<a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.ja">クリエイティブ・コモンズ 表示 4.0 国際 ライセンス</a>の下に提供されています。</div>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="../../js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../../js/bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="../../js/clean-blog.js"></script>

</body>

</html>
